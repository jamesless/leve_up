<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆå›æ”¾ - æ‰¾æœ‹å‹å‡çº§</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .replay-container {
            max-width: 1200px;
            margin: 80px auto 40px;
            padding: 20px;
        }

        .replay-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .replay-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
        }

        .info-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }

        .replay-controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .control-btn:hover {
            background: #45a049;
        }

        .control-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .control-btn.secondary {
            background: #2196F3;
        }

        .control-btn.secondary:hover {
            background: #0b7dda;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s;
        }

        .progress-text {
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
            text-align: center;
        }

        .replay-view {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .action-log {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }

        .action-item {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            transition: background 0.3s;
        }

        .action-item:last-child {
            border-bottom: none;
        }

        .action-item.current {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .action-item.past {
            opacity: 0.6;
        }

        .action-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .action-type {
            font-weight: bold;
            color: #2196F3;
        }

        .action-time {
            font-size: 0.85em;
            color: #999;
        }

        .action-player {
            color: #666;
            margin-bottom: 5px;
        }

        .action-details {
            background: #f5f5f5;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .final-results {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .final-results.host-win {
            background: #e3f2fd;
        }

        .final-results h3 {
            margin-top: 0;
            color: #2e7d32;
        }

        .final-results.host-win h3 {
            color: #1565c0;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .result-item {
            padding: 10px;
            background: white;
            border-radius: 4px;
        }

        .back-btn {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: #666;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .back-btn:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="replay-container">
        <a href="/game" class="back-btn">â† è¿”å›æ¸¸æˆå¤§å…</a>

        <div class="replay-header">
            <h1>æ¸¸æˆå›æ”¾</h1>
            <div id="replayInfo" class="replay-info"></div>
        </div>

        <div class="replay-controls">
            <div class="control-buttons">
                <button class="control-btn" id="playBtn" onclick="togglePlay()">â–¶ æ’­æ”¾</button>
                <button class="control-btn secondary" id="prevBtn" onclick="prevAction()">â® ä¸Šä¸€æ­¥</button>
                <button class="control-btn secondary" id="nextBtn" onclick="nextAction()">ä¸‹ä¸€æ­¥ â­</button>
                <button class="control-btn secondary" id="resetBtn" onclick="resetReplay()">âª é‡æ–°å¼€å§‹</button>
                <select id="speedSelect" onchange="changeSpeed()" style="padding: 10px; border-radius: 4px; border: 1px solid #ccc;">
                    <option value="0.5">0.5x é€Ÿåº¦</option>
                    <option value="1" selected>1x é€Ÿåº¦</option>
                    <option value="2">2x é€Ÿåº¦</option>
                    <option value="4">4x é€Ÿåº¦</option>
                </select>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">0 / 0</div>
        </div>

        <div class="replay-view">
            <h3>åŠ¨ä½œå†å²</h3>
            <div class="action-log" id="actionLog"></div>
        </div>

        <div id="finalResults"></div>
    </div>

    <script>
        const GAME_ID = '{{.gameID}}';
        let actions = [];
        let replayData = null;
        let currentIndex = 0;
        let isPlaying = false;
        let playSpeed = 1000; // ms per action
        let playInterval = null;

        // Action type translations
        const actionTypes = {
            'call_dealer': 'æŠ¢åº„',
            'call_friend': 'å«æœ‹å‹ç‰Œ',
            'discard_bottom': 'æ‰£åº•ç‰Œ',
            'play_cards': 'å‡ºç‰Œ',
            'trick_complete': 'è½®æ¬¡å®Œæˆ',
            'game_end': 'æ¸¸æˆç»“æŸ'
        };

        async function loadReplay() {
            try {
                // Load actions
                const actionsResp = await fetch(`/api/game/${GAME_ID}/actions`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                const actionsData = await actionsResp.json();
                actions = actionsData.actions || [];

                // Load replay metadata
                const replayResp = await fetch(`/api/game/${GAME_ID}/replay`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                const replayJson = await replayResp.json();
                replayData = replayJson.replay;

                displayReplayInfo();
                renderActions();
                updateProgress();
            } catch (error) {
                console.error('Failed to load replay:', error);
                alert('åŠ è½½å›æ”¾å¤±è´¥');
            }
        }

        function displayReplayInfo() {
            const info = document.getElementById('replayInfo');
            if (!replayData) return;

            const initialState = JSON.parse(replayData.initialState);
            const finalState = JSON.parse(replayData.finalState);

            const trumpSuitSymbol = {
                'spade': 'â™ ',
                'heart': 'â™¥',
                'club': 'â™£',
                'diamond': 'â™¦'
            };

            info.innerHTML = `
                <div class="info-item">
                    <div class="info-label">æ¸¸æˆID</div>
                    <div class="info-value">${replayData.gameId}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ä¸»ç‰ŒèŠ±è‰²</div>
                    <div class="info-value">${trumpSuitSymbol[initialState.trumpSuit] || initialState.trumpSuit}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">çº§ç‰Œ</div>
                    <div class="info-value">${initialState.trumpRank || 'æœªçŸ¥'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æ€»åŠ¨ä½œæ•°</div>
                    <div class="info-value">${replayData.totalActions}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æ¸¸æˆæ—¶é•¿</div>
                    <div class="info-value">${formatDuration(replayData.durationSeconds)}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">è·èƒœæ–¹</div>
                    <div class="info-value">${replayData.winnerTeam === 'host' ? 'åº„å®¶æ–¹' : 'æŠ“åˆ†æ–¹'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æœ€ç»ˆå¾—åˆ†</div>
                    <div class="info-value">${finalState.totalPoints || replayData.finalScore}</div>
                </div>
            `;

            // Display final results
            if (finalState.results && finalState.results.length > 0) {
                displayFinalResults(finalState.results);
            }
        }

        function displayFinalResults(results) {
            const container = document.getElementById('finalResults');
            const winnerClass = replayData.winnerTeam === 'host' ? 'host-win' : '';

            let resultsHTML = '<div class="results-grid">';
            results.forEach(result => {
                const levelChange = result.new_level !== result.old_level ?
                    `${result.old_level} â†’ ${result.new_level}` : result.old_level;
                resultsHTML += `
                    <div class="result-item">
                        <div style="font-weight: bold; margin-bottom: 5px;">
                            ${result.is_winner ? 'ğŸ† ' : ''}ç©å®¶ ${result.user_id.substring(0, 8)}
                        </div>
                        <div style="font-size: 0.9em; color: #666;">
                            ç­‰çº§: ${levelChange}
                        </div>
                    </div>
                `;
            });
            resultsHTML += '</div>';

            container.innerHTML = `
                <div class="final-results ${winnerClass}">
                    <h3>${replayData.winnerTeam === 'host' ? 'åº„å®¶æ–¹' : 'æŠ“åˆ†æ–¹'}è·èƒœï¼</h3>
                    ${resultsHTML}
                </div>
            `;
        }

        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}åˆ†${secs}ç§’`;
        }

        function renderActions() {
            const log = document.getElementById('actionLog');
            log.innerHTML = '';

            actions.forEach((action, index) => {
                const div = document.createElement('div');
                div.className = 'action-item';
                if (index === currentIndex) {
                    div.className += ' current';
                } else if (index < currentIndex) {
                    div.className += ' past';
                }

                const time = new Date(action.timestamp).toLocaleTimeString('zh-CN');
                const typeText = actionTypes[action.actionType] || action.actionType;

                let details = '';
                try {
                    const data = JSON.parse(action.actionData);
                    details = formatActionDetails(action.actionType, data);
                } catch (e) {
                    details = '';
                }

                div.innerHTML = `
                    <div class="action-header">
                        <span class="action-type">${typeText}</span>
                        <span class="action-time">${time}</span>
                    </div>
                    <div class="action-player">ç©å®¶åº§ä½: ${action.playerSeat || 'ç³»ç»Ÿ'}</div>
                    ${details ? `<div class="action-details">${details}</div>` : ''}
                `;

                div.onclick = () => jumpToAction(index);
                log.appendChild(div);
            });
        }

        function formatActionDetails(type, data) {
            switch (type) {
                case 'play_cards':
                    if (data.cards && data.cards.length > 0) {
                        const cards = data.cards.map(c => `${getSuitSymbol(c.suit)}${c.value}`).join(' ');
                        return `å‡ºç‰Œ: ${cards} (${data.play_type || 'å•å¼ '})`;
                    }
                    return `å‡ºç‰Œ: ${data.cardIndices ? data.cardIndices.length : 0}å¼ `;
                case 'discard_bottom':
                    return `æ‰£åº•ç‰Œ: ${data.cardIndices ? data.cardIndices.length : 0}å¼ `;
                case 'call_friend':
                    return `å«ç‰Œ: ${getSuitSymbol(data.suit)}${data.value} (ç¬¬${data.position}å¼ )`;
                case 'call_dealer':
                    return `æŠ¢åº„: ${getSuitSymbol(data.suit)} (${data.cardIndices ? data.cardIndices.length : 0}å¼ )`;
                case 'trick_complete':
                    return `è·èƒœåº§ä½: ${data.winner_seat}, å¾—åˆ†: ${data.points_collected || 0}`;
                case 'game_end':
                    return `æ¸¸æˆç»“æŸ`;
                default:
                    return '';
            }
        }

        function getSuitSymbol(suit) {
            const symbols = { 'spade': 'â™ ', 'heart': 'â™¥', 'club': 'â™£', 'diamond': 'â™¦', 'joker': 'ğŸƒ' };
            return symbols[suit] || suit;
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            const btn = document.getElementById('playBtn');

            if (isPlaying) {
                btn.textContent = 'â¸ æš‚åœ';
                startAutoPlay();
            } else {
                btn.textContent = 'â–¶ æ’­æ”¾';
                stopAutoPlay();
            }
        }

        function startAutoPlay() {
            if (currentIndex >= actions.length - 1) {
                currentIndex = 0;
            }

            playInterval = setInterval(() => {
                if (currentIndex < actions.length - 1) {
                    nextAction();
                } else {
                    togglePlay();
                }
            }, playSpeed);
        }

        function stopAutoPlay() {
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
        }

        function nextAction() {
            if (currentIndex < actions.length - 1) {
                currentIndex++;
                renderActions();
                updateProgress();
                scrollToCurrentAction();
            }
        }

        function prevAction() {
            if (currentIndex > 0) {
                currentIndex--;
                renderActions();
                updateProgress();
                scrollToCurrentAction();
            }
        }

        function jumpToAction(index) {
            stopAutoPlay();
            isPlaying = false;
            document.getElementById('playBtn').textContent = 'â–¶ æ’­æ”¾';
            currentIndex = index;
            renderActions();
            updateProgress();
        }

        function resetReplay() {
            stopAutoPlay();
            isPlaying = false;
            document.getElementById('playBtn').textContent = 'â–¶ æ’­æ”¾';
            currentIndex = 0;
            renderActions();
            updateProgress();
        }

        function changeSpeed() {
            const select = document.getElementById('speedSelect');
            const speed = parseFloat(select.value);
            playSpeed = 1000 / speed;

            if (isPlaying) {
                stopAutoPlay();
                startAutoPlay();
            }
        }

        function updateProgress() {
            const fill = document.getElementById('progressFill');
            const text = document.getElementById('progressText');
            const progress = actions.length > 0 ? (currentIndex / (actions.length - 1)) * 100 : 0;

            fill.style.width = progress + '%';
            text.textContent = `${currentIndex + 1} / ${actions.length}`;
        }

        function scrollToCurrentAction() {
            const log = document.getElementById('actionLog');
            const current = log.querySelector('.action-item.current');
            if (current) {
                current.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Load replay on page load
        window.onload = loadReplay;
    </script>
</body>
</html>
