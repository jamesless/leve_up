# 自动化测试系统架构图

## 系统组件

```
┌─────────────────────────────────────────────────────────────────┐
│                         自动化测试系统                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐  │
│  │ automation_  │      │ automated_   │      │ rule_        │  │
│  │ runner.sh    │─────▶│ validator.go │─────▶│ validator.go │  │
│  │              │      │              │      │              │  │
│  │ 主控脚本      │      │ 游戏测试引擎   │      │ 规则验证器    │  │
│  └──────────────┘      └──────┬───────┘      └──────┬───────┘  │
│                                │                      │           │
│                                │                      │           │
│                                ▼                      ▼           │
│                        ┌──────────────┐      ┌──────────────┐   │
│                        │ HTTP Client  │      │ 日志分析      │   │
│                        │              │      │              │   │
│                        │ API 调用      │      │ 规则检查      │   │
│                        └──────┬───────┘      └──────┬───────┘   │
└───────────────────────────────┼──────────────────────┘         │
                                │                                  │
┌───────────────────────────────┼──────────────────────────────────┐
│                               │                                  │
│  ┌────────────────────────────┼────────────────────────────┐    │
│  │                    游戏服务器 (Go)                        │    │
│  ├────────────────────────────┼────────────────────────────┤    │
│  │                            │                             │    │
│  │  ┌─────────┐  ┌─────────┐  │  ┌─────────┐  ┌─────────┐  │    │
│  │  │  API    │ │ Models  │  │ │Handlers │  │  AI     │  │    │
│  │  │ Routes  │  │         │  │  │         │  │ Player  │  │    │
│  │  └────┬────┘  └────┬────┘  │  └────┬────┘  └────┬────┘  │    │
│  │       │            │        │       │            │       │    │
│  └───────┼────────────┼────────┼───────┼────────────┼───────┘    │
│          │            │        │       │            │            │
└──────────┼────────────┼────────┼───────┼────────────┼────────────┘
           │            │        │       │            │
           ▼            ▼        ▼       ▼            ▼
    ┌─────────────────────────────────────────────────────┐
    │              数据存储                                │
    ├─────────────────────────────────────────────────────┤
    │  ┌──────────┐  ┌──────────┐  ┌─────────────────┐   │
    │  │ Database │  │   Logs   │  │  Git Repository │   │
    │  │ (SQLite) │  │ (JSONL)  │  │                 │   │
    │  └──────────┘  └──────────┘  └─────────────────┘   │
    └─────────────────────────────────────────────────────┘
```

## 数据流

```
┌─────────────────────────────────────────────────────────────┐
│                      测试执行流程                             │
└─────────────────────────────────────────────────────────────┘

1. 初始化
   automation_runner.sh 启动
   │
   ├─▶ 检查服务器状态
   ├─▶ 生成版本号 (v1.20240101_120000)
   └─▶ 创建日志目录

2. 游戏测试
   automated_validator.go 运行
   │
   ├─▶ 创建/登录测试用户
   ├─▶ 创建单人游戏
   ├─▶ 启动游戏
   │
   ├─▶ 游戏1 ─┐
   ├─▶ 游戏2 ─┤ 自动进行3场游戏
   ├─▶ 游戏3 ─┘
   │     │
   │     └─▶ 记录所有事件到日志
   │
   └─▶ 保存日志到 log/v1.xxxxx/

3. 规则验证
   rule_validator.go 运行
   │
   ├─▶ 读取日志文件
   ├─▶ 解析JSONL格式
   │
   ├─▶ 验证发牌规则
   ├─▶ 验证出牌规则
   ├─▶ 验证计分规则
   └─▶ 验证升级规则

4. 结果处理
   │
   ├─▶ 通过？
   │   │
   │   ├─ 是 ─▶ 提交代码到Git
   │   │         └─▶ 完成
   │   │
   │   └─ 否 ─▶ 显示错误
   │             └─▶ 尝试修复
   │                   └─▶ 回到步骤2
   │
   └─▶ 达到最大迭代？
       └─▶ 终止并报错
```

## 日志事件流

```
单个游戏的事件序列:

┌──────────────────────────────────────────────────────────┐
│ Game Events Timeline                                     │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  1. deal (发牌)                                          │
│     ├─ trumpSuit: "spades"                              │
│     └─ totalCards: 162                                  │
│                                                          │
│  2. play (玩家1出牌)                                     │
│     ├─ playerSeat: 1                                    │
│     └─ card: {suit: "spades", value: "A"}              │
│                                                          │
│  3. play (玩家2出牌)                                     │
│     ├─ playerSeat: 2                                    │
│     └─ card: {suit: "spades", value: "K"}              │
│                                                          │
│  4. play (玩家3出牌)                                     │
│     ├─ playerSeat: 3                                    │
│     └─ card: {suit: "hearts", value: "5"}  (垫牌)       │
│                                                          │
│  5. play (玩家4出牌)                                     │
│     ├─ playerSeat: 4                                    │
│     └─ card: {suit: "spades", value: "Q"}              │
│                                                          │
│  6. play (玩家5出牌)                                     │
│     ├─ playerSeat: 5                                    │
│     └─ card: {suit: "joker", value: "big"}  (毙牌)     │
│                                                          │
│  7. trick_end (一轮结束)                                 │
│     ├─ winner: 5 (玩家5获胜)                             │
│     └─ scores: {player1: 0, player5: 10}                │
│                                                          │
│  8-31. 重复play和trick_end (共31轮)                       │
│                                                          │
│  32. game_end (游戏结束)                                  │
│      ├─ totalTurns: 31                                   │
│      ├─ finalScores: {...}                               │
│      └─ winner: team1                                    │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

## 规则验证树

```
规则验证
│
├─▶ 发牌规则验证
│   ├─ 总牌数 = 162
│   ├─ 每玩家31张
│   ├─ 底牌7张
│   └─ 主牌花色已设置
│
├─▶ 出牌规则验证
│   ├─ 出牌顺序正确
│   │   └─ 1→2→3→4→5→1
│   ├─ 跟牌规则
│   │   ├─ 有花色必须跟
│   │   └─ 无花色可垫/毙
│   ├─ 牌型支持
│   │   ├─ 单张 ✓
│   │   ├─ 对子 ✓
│   │   ├─ 三张 ✓
│   │   ├─ 拖拉机 ✓
│   │   └─ 甩牌 ✓
│   └─ 大小比较
│       ├─ 同花色比点数
│       ├─ 主牌 > 副牌
│       └─ 大王 > 小王 > 主牌
│
├─▶ 计分规则验证
│   ├─ 分牌识别
│   │   ├─ 5 = 5分
│   │   ├─ 10 = 10分
│   │   └─ K = 10分
│   ├─ 总分 = 300
│   └─ 抠底倍数
│       ├─ 单张 ×2
│       ├─ 对子 ×4
│       └─ 三张 ×8
│
└─▶ 升级规则验证
    ├─ 正常局(2打3)
    │   ├─ 0分 → 庄家+3
    │   ├─ 1-59分 → 庄家+2
    │   ├─ 60-119分 → 庄家+1
    │   ├─ 120-179分 → 抓分方+1
    │   ├─ 180-239分 → 抓分方+2
    │   ├─ 240-299分 → 抓分方+3
    │   └─ 300分 → 抓分方+4
    └─ 独打局(1打4)
        ├─ 0-59分 → 庄家+4
        ├─ 60-119分 → 庄家+2
        ├─ 120-179分 → 抓分方+1
        └─ ≥180分 → 抓分方+2
```

## 文件依赖关系

```
┌─────────────────────────────────────────────────────────┐
│                    文件依赖图                            │
└─────────────────────────────────────────────────────────┘

automation_runner.sh
  │
  ├─▶ automated_validator.go
  │     ├─▶ net/http (HTTP客户端)
  │     ├─▶ encoding/json (JSON解析)
  │     └─▶ os/time (系统功能)
  │
  └─▶ rule_validator.go
        ├─▶ encoding/json (日志解析)
        ├─▶ os (文件读取)
        └─▶ path/filepath (路径处理)

all ─▶ main.go (游戏服务器)
        ├─▶ handlers/
        ├─▶ models/
        ├─▶ templates/
        └─▶ static/
```

## 错误处理流程

```
┌─────────────────────────────────────────────────────────┐
│                    错误处理                              │
└─────────────────────────────────────────────────────────┘

测试执行中发现错误
│
├─▶ 错误分类
│   ├─ error (严重错误)
│   │   └─ 必须修复才能继续
│   ├─ warning (警告)
│   │   └─ 建议修复
│   └─ info (信息)
│       └─ 仅供参考
│
├─▶ 生成报告
│   ├─ 错误描述
│   ├─ 规则说明
│   ├─ 违规详情
│   ├─ 上下文信息
│   └─ 修复建议
│
└─▶ 处理决策
    ├─ 可自动修复?
    │   ├─ 是 ─▶ 应用修复
    │   │         └─▶ 重新测试
    │   │
    │   └─ 否 ─▶ 报告给开发者
    │                 └─▶ 等待手动修复
    │
    └─▶ 迭代计数
        ├─ < MAX_ITERATIONS
        │   └─▶ 继续下一轮
        │
        └─ ≥ MAX_ITERATIONS
            └─▶ 终止并报错
```

## Git集成流程

```
┌─────────────────────────────────────────────────────────┐
│                    Git提交流程                           │
└─────────────────────────────────────────────────────────┘

测试全部通过
│
├─▶ git add
│   ├─ main.go
│   ├─ models/
│   ├─ handlers/
│   ├─ templates/
│   ├─ static/
│   └─ test/*.go
│
├─▶ git commit
│   ├─ 标题: "测试通过 - v1.xxxxx"
│   ├─ 内容:
│   │   ├─ 完成3场完整游戏测试
│   │   ├─ 所有规则验证通过
│   │   └─ 自动化测试系统验证
│   └─ 签名: Co-Authored-By: Claude
│
└─▶ git push (可选)
    └─▶ 推送到远程仓库
```

---

**创建日期**: 2026-02-26
**版本**: 1.0
