# 自动化测试系统说明

## 概述

这个自动化测试系统用于验证升级游戏的游戏逻辑是否符合规则。系统会：

1. **进行3场完整游戏**，记录所有操作到日志
2. **验证日志**是否符合游戏规则
3. **自动修复**发现的问题
4. **循环测试**直到所有测试通过
5. **提交代码**到git仓库

## 文件说明

### 1. `automated_validator.go`
主要的自动化测试脚本，负责：
- 创建并运行3场单人游戏
- 记录所有游戏事件到JSON日志
- 与游戏服务器API交互

### 2. `rule_validator.go`
规则验证器，负责：
- 读取游戏日志
- 验证是否符合游戏规则
- 生成详细的验证报告

### 3. `automation_runner.sh`
自动化运行脚本，负责：
- 协调整个测试循环
- 调用其他组件
- 处理代码提交

## 使用方法

### 准备工作

1. **启动游戏服务器**
```bash
cd /Users/ken/my_project/leve_up
go run main.go
```

2. **确保数据库已初始化**
```bash
# 如果需要，创建数据库
# 默认使用SQLite数据库：game.db
```

### 运行自动化测试

#### 方法1: 使用自动化运行脚本（推荐）
```bash
cd /Users/ken/my_project/leve_up/test
./automation_runner.sh
```

这个脚本会：
1. 检查服务器是否运行
2. 生成新的版本号（如 `v1.20240101_120000`）
3. 运行3场游戏并记录日志
4. 验证日志是否符合规则
5. 如果有错误，尝试修复并重新测试
6. 如果全部通过，提交代码到git

#### 方法2: 手动运行各个组件

**步骤1: 运行游戏测试**
```bash
cd /Users/ken/my_project/leve_up/test
go run automated_validator.go
```

**步骤2: 验证日志**
```bash
go run rule_validator.go log/v1.20240101_120000
```

**步骤3: 如果通过，手动提交代码**
```bash
cd /Users/ken/my_project/leve_up
git add main.go models/ handlers/ templates/ static/ test/*.go
git commit -m "测试通过 - 游戏逻辑验证通过"
git push
```

## 日志文件结构

```
log/
└── v1.20240101_120000/          # 版本目录
    ├── combined_log.jsonl       # 所有事件的合并日志（JSONL格式）
    ├── game_1.json              # 第1场游戏的详细日志
    ├── game_2.json              # 第2场游戏的详细日志
    └── game_3.json              # 第3场游戏的详细日志
```

## 日志事件类型

每条日志事件包含以下字段：

```json
{
  "timestamp": "2024-01-01T12:00:00Z",
  "gameId": "game_id_here",
  "eventType": "play",           // 事件类型
  "playerId": "player_id_here",
  "playerSeat": 1,
  "card": {                      // 如果是出牌事件
    "suit": "hearts",
    "value": "A"
  },
  "trick": [...],                // 如果是一轮结束
  "scores": {...},               // 如果有分数信息
  "winner": 1,                   // 赢家位置
  "metadata": {}                 // 其他元数据
}
```

### 事件类型说明

- **deal**: 发牌事件
- **play**: 玩家出牌
- **trick_end**: 一轮结束
- **game_end**: 游戏结束

## 验证规则

系统验证以下规则类别：

### 发牌规则
- ✅ 5个玩家，每人31张牌，底牌7张，总计162张
- ✅ 发牌后必须设置主牌花色

### 出牌规则
- ✅ 玩家按顺时针顺序出牌 (1→2→3→4→5→1)
- ✅ 必须跟首家花色，无花色可垫牌或毙牌
- ✅ 支持牌型: 单张、对子、三张、拖拉机、甩牌
- ✅ 甩牌需保证同花色组合最大
- ✅ 主牌可以毙副牌
- ✅ 王牌最大: 大王 > 小王 > 主牌 > 副牌

### 计分规则
- ✅ 分牌: 5=5分, 10=10分, K=10分
- ✅ 总分300分
- ✅ 抠底倍数: 单张×2，对子×4，三张×8

### 升级规则
- ✅ 正常局(2打3): 根据抓分确定升级级数
- ✅ 独打局(1打4): 根据抓分确定升级级数

## 故障排除

### 问题1: 服务器未运行
```
❌ 错误: 游戏服务器未运行
```
**解决方法**: 先启动游戏服务器
```bash
cd /Users/ken/my_project/leve_up
go run main.go
```

### 问题2: 数据库错误
```
❌ 数据库初始化失败
```
**解决方法**: 检查数据库文件权限，或删除重新创建
```bash
rm -f game.db
go run main.go  # 会自动创建新数据库
```

### 问题3: 端口被占用
```
❌ 端口8080已被占用
```
**解决方法**: 检查并关闭占用端口的进程
```bash
lsof -ti:8080 | xargs kill -9
```

### 问题4: 日志验证失败
```
❌ 发现5个规则违规
```
**解决方法**:
1. 查看详细的验证报告
2. 检查违规的上下文信息
3. 修复相关代码
4. 重新运行测试

## 扩展和自定义

### 添加新的验证规则

编辑 `rule_validator.go`，在 `initializeRules()` 函数中添加新规则：

```go
rv.Rules = append(rv.Rules, GameRule{
    Name:        "新规则名称",
    Description: "规则描述",
    Category:    "playing", // 或其他类别
})
```

然后在相应的验证函数中添加检查逻辑。

### 修改测试游戏数量

编辑 `automated_validator.go`，找到循环：

```go
// 将3改为其他数字
for i := 1; i <= 3; i++ {
    // ...
}
```

### 修改最大迭代次数

编辑 `automation_runner.sh`：

```bash
MAX_ITERATIONS=10  # 改为其他数字
```

## 输出示例

### 成功输出
```
========================================
   自动化测试系统启动
========================================
版本号: v1.20240101_120000
日志目录: /Users/ken/my_project/leve_up/log

✅ 服务器运行正常
登录成功: autotest_1234567890
游戏ID: abc123
游戏结束，共 31 轮
✅ 游戏 1 完成
游戏结束，共 32 轮
✅ 游戏 2 完成
游戏结束，共 30 轮
✅ 游戏 3 完成

✅ 日志已保存到: /Users/ken/my_project/leve_up/log/v1.20240101_120000

=========================================
   规则验证报告
=========================================
✅ 所有规则验证通过！

=========================================
   提交代码
=========================================
✅ 代码提交成功
🎉 所有测试通过，代码已提交！
```

### 失败输出
```
=========================================
   规则验证报告
=========================================

📊 统计:
   错误: 2
   警告: 1
   信息: 0

❌ 错误:

[1] 发牌规则 - 主牌设置
    发牌后未设置主牌花色
    💡 建议: 确保在发牌逻辑中正确设置主牌花色
    上下文:
      - GameID: abc123
      - 期望: trumpSuit 不为空
      - 实际: trumpSuit = ''

[2] 出牌规则 - 出牌顺序
    出牌顺序可能不正确
    💡 建议: 检查出牌逻辑，确保按顺时针顺序
    上下文:
      - GameID: abc123
      - 期望位置: 3
      - 实际位置: 5
```

## 注意事项

1. **数据库会累积**: 每次运行会创建新用户和游戏，定期清理数据库
2. **日志文件**: 只保留最近几个版本的日志，旧版本可以删除
3. **Git提交**: 确保在运行前已经配置好git
4. **服务器依赖**: 必须先启动服务器才能运行测试

## 贡献

如果发现问题或有改进建议，请：
1. 创建issue描述问题
2. 或提交pull request

## 许可

与主项目相同。
