# BUGä¿®å¤å®ŒæˆæŠ¥å‘Š - å•äººæ¨¡å¼æ¸¸æˆ

**ä¿®å¤æ—¶é—´**: 2026-02-26
**æµ‹è¯•å·¥å…·**: Playwright Browser MCP
**é—®é¢˜æ¥æº**: æµè§ˆå™¨MCPæµ‹è¯•æŠ¥å‘Š

---

## ä¿®å¤æ‘˜è¦

æˆåŠŸä¿®å¤äº†å•äººæ¨¡å¼æ¸¸æˆæ— æ³•æ˜¾ç¤ºæ‰‹ç‰Œçš„ä¸¥é‡bugã€‚ä¿®å¤æ¶‰åŠ**2ä¸ªä»£ç æ–‡ä»¶**çš„**3å¤„ä¿®æ”¹**ã€‚

**ä¿®å¤ç»“æœ**: âœ… æˆåŠŸ - æ¸¸æˆç°åœ¨å¯ä»¥æ­£å¸¸å¯åŠ¨å¹¶æ˜¾ç¤ºæ‰‹ç‰Œ

---

## ä¿®å¤çš„é—®é¢˜

### ğŸ”´ é—®é¢˜1: åç«¯çŠ¶æ€åˆ¤æ–­é”™è¯¯å¯¼è‡´æ‰‹ç‰Œæœªä¼ é€’

**æ–‡ä»¶**: `handlers/handlers.go`
**ä½ç½®**: ç¬¬935è¡Œ
**é—®é¢˜**: åªåœ¨ `status == "playing"` æ—¶æä¾›æ‰‹ç‰Œï¼Œä½†æ¸¸æˆå¯åŠ¨åè¿›å…¥ "discarding" çŠ¶æ€

**ä¿®å¤å‰**:
```go
// Get my hand (human player is always seat 1)
var myHand *models.PlayerHand
if table.Status == "playing" {
    myHand = table.PlayerHands[1]
}
```

**ä¿®å¤å**:
```go
// Get my hand (human player is always seat 1)
var myHand *models.PlayerHand
if table.Status != "waiting" && table.Status != "finished" {
    myHand = table.PlayerHands[1]
}
```

**ä¿®å¤è¯´æ˜**: æ”¹ä¸ºæ’é™¤ "waiting" å’Œ "finished" çŠ¶æ€ï¼Œåœ¨æ‰€æœ‰æ¸¸æˆè¿›è¡Œä¸­çš„çŠ¶æ€ï¼ˆcallingã€discardingã€playingï¼‰éƒ½æä¾›æ‰‹ç‰Œæ•°æ®ã€‚

---

### ğŸŸ¡ é—®é¢˜2: å‰ç«¯å­—æ®µåå¤§å°å†™ä¸ä¸€è‡´

**æ–‡ä»¶**: `templates/singleplayer_game.html`
**ä½ç½®**: ç¬¬674è¡Œå’Œç¬¬686è¡Œ

**ä¿®å¤å‰**:
```javascript
const myHand = GAME_DATA.myHand;
if (!myHand || !myHand.Cards) {  // é”™è¯¯ï¼šä½¿ç”¨å¤§å†™Cards
    return;
}
// ...
const cards = myHand.Cards.map((card, index) => ({...card, originalIndex: index}));
const aIsTrump = a.Suit === trumpSuit || a.Value === trumpRank;  // é”™è¯¯ï¼šä½¿ç”¨å¤§å†™Suit/Value
```

**ä¿®å¤å**:
```javascript
const myHand = GAME_DATA.myHand;
if (!myHand || !myHand.cards) {  // æ­£ç¡®ï¼šä½¿ç”¨å°å†™cards
    return;
}
// ...
const cards = myHand.cards.map((card, index) => ({...card, originalIndex: index}));
const aIsTrump = a.suit === trumpSuit || a.value === trumpRank;  // æ­£ç¡®ï¼šä½¿ç”¨å°å†™suit/value
```

**ä¿®å¤è¯´æ˜**: ç»Ÿä¸€ä½¿ç”¨å°å†™å­—æ®µå `cards`ã€`suit`ã€`value`ï¼Œä¸åç«¯JSONåºåˆ—åŒ–ä¿æŒä¸€è‡´ã€‚

---

### ğŸŸ¢ æ–°å¢åŠŸèƒ½: å‰ç«¯è‡ªåŠ¨å¯åŠ¨æ¸¸æˆ

**æ–‡ä»¶**: `templates/singleplayer_game.html`
**ä½ç½®**: ç¬¬617-660è¡Œï¼ˆæ–°å¢ä»£ç ï¼‰

**é—®é¢˜åˆ†æ**:
- é¡µé¢åŠ è½½æ—¶æ¸¸æˆçŠ¶æ€ä¸º "waiting"
- `SinglePlayerGamePageHandler` éœ€è¦cookieè®¤è¯æ‰èƒ½è‡ªåŠ¨å¯åŠ¨æ¸¸æˆ
- ä½†å‰ç«¯ä½¿ç”¨localStorageå­˜å‚¨tokenï¼Œæ²¡æœ‰cookie
- å¯¼è‡´åç«¯æ— æ³•è¯†åˆ«ç”¨æˆ·ï¼Œé¡µé¢æ¸²æŸ“æ—¶ä¸å¯åŠ¨æ¸¸æˆ

**è§£å†³æ–¹æ¡ˆ**: åœ¨å‰ç«¯æ·»åŠ è‡ªåŠ¨å¯åŠ¨é€»è¾‘

**æ–°å¢ä»£ç **:
```javascript
function renderGame() {
    // æ£€æŸ¥æ¸¸æˆçŠ¶æ€
    if (GAME_DATA.status === 'waiting') {
        // è‡ªåŠ¨å¯åŠ¨å•äººæ¸¸æˆ
        autoStartSinglePlayerGame();
        return;
    }

    if (GAME_DATA.status === 'calling') {
        handleCallingPhase();
        return;
    }

    if (GAME_DATA.status === 'discarding') {
        handleDiscardingPhase();
        return;
    }

    renderMyHand();
    updateDisplay();
    updateSelectionCounter();
    updatePlayerInfoPanel();
}

// è‡ªåŠ¨å¯åŠ¨å•äººæ¸¸æˆ
async function autoStartSinglePlayerGame() {
    const token = localStorage.getItem('token');
    if (!token) {
        showStatus('è¯·å…ˆç™»å½•');
        return;
    }

    try {
        showStatus('æ­£åœ¨å¯åŠ¨æ¸¸æˆ...');
        const response = await fetch(`/api/game/${GAME_ID}/start-single`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();

        if (result.success) {
            // é‡æ–°åŠ è½½æ¸¸æˆæ•°æ®
            await loadGameDataFromAPI();
        } else {
            showStatus('å¯åŠ¨æ¸¸æˆå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (e) {
        console.error('Failed to start game:', e);
        showStatus('ç½‘ç»œé”™è¯¯');
    }
}
```

**åŠŸèƒ½è¯´æ˜**:
1. æ£€æµ‹æ¸¸æˆçŠ¶æ€ä¸º "waiting" æ—¶è‡ªåŠ¨è°ƒç”¨å¯åŠ¨API
2. ä½¿ç”¨localStorageä¸­çš„tokenè¿›è¡Œè®¤è¯
3. å¯åŠ¨æˆåŠŸåé‡æ–°åŠ è½½æ¸¸æˆæ•°æ®
4. æ˜¾ç¤ºå‹å¥½çš„çŠ¶æ€æç¤º

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤
1. âœ… è®¿é—®æ¸¸æˆå¤§å…
2. âœ… ç‚¹å‡»"å•äººæ¨¡å¼"æŒ‰é’®
3. âœ… é¡µé¢è‡ªåŠ¨å¯åŠ¨æ¸¸æˆï¼ˆæ˜¾ç¤º"æ­£åœ¨å¯åŠ¨æ¸¸æˆ..."ï¼‰
4. âœ… æ¸¸æˆè¿›å…¥åŸ‹åº•ç‰Œé˜¶æ®µï¼ˆdiscardingï¼‰
5. âœ… æ­£ç¡®æ˜¾ç¤º"æˆ‘çš„æ‰‹ç‰Œ (38å¼ )"
6. âœ… æ‰€æœ‰æ‰‹ç‰Œæ­£ç¡®æ¸²æŸ“å¹¶å¯ç‚¹å‡»
7. âœ… æ˜¾ç¤ºä¸»ç‰ŒèŠ±è‰²ï¼ˆæ–¹ç‰‡ï¼‰
8. âœ… é€‰ç‰ŒåŠŸèƒ½æ­£å¸¸å·¥ä½œ

### æµ‹è¯•ç»“æœ
```
æ¸¸æˆID: 1772103274081717300
æ¸¸æˆçŠ¶æ€: discarding
å°†ç‰Œ: æ–¹ç‰‡
ç©å®¶æ‰‹ç‰Œ: 38å¼ ï¼ˆ31å¼ æ‰‹ç‰Œ + 7å¼ åº•ç‰Œï¼‰
AIç©å®¶: 4ä¸ªï¼Œæ¯ä¸ª31å¼ æ‰‹ç‰Œ
```

### é¡µé¢æˆªå›¾ï¼ˆé€šè¿‡å¿«ç…§ï¼‰
- é¡µé¢æ ‡é¢˜æ˜¾ç¤º: "å•äººæ¸¸æˆ - æ‰¾æœ‹å‹å‡çº§"
- é¡¶éƒ¨ä¿¡æ¯: "æˆ‘ 2çº§"ã€"å°†ç‰Œ: æ–¹ç‰‡"ã€"ç¬¬1è½®"
- AIç©å®¶: AI-2ã€AI-3ã€AI-4ã€AI-5 å„31å¼ ç‰Œ
- æˆ‘çš„æ‰‹ç‰ŒåŒºåŸŸ: 38å¼ ç‰Œå®Œæ•´å±•ç¤º
- åº•éƒ¨æŒ‰é’®: "æ‰£ç‰Œ (1/7)"ã€"ğŸ’¡ æç¤º"
- çŠ¶æ€æç¤º: "è¯·é€‰æ‹©7å¼ ç‰Œæ‰£å›åº•ç‰Œï¼ˆåº„å®¶ï¼‰"

---

## ä¿®å¤çš„æŠ€æœ¯ç»†èŠ‚

### æ ¹æœ¬åŸå› åˆ†æ

**åŸå§‹bugçš„å®Œæ•´è°ƒç”¨é“¾**:
```
1. ç”¨æˆ·ç‚¹å‡»"å•äººæ¨¡å¼"
   â†’ POST /api/game/singleplayer (åˆ›å»ºæ¸¸æˆï¼ŒçŠ¶æ€=waiting)

2. é‡å®šå‘åˆ° GET /game/singleplayer/{id}
   â†’ SinglePlayerGamePageHandler æ‰§è¡Œ
   â†’ æ£€æŸ¥ç”¨æˆ·è®¤è¯ï¼ˆcookieï¼‰
   â†’ âŒ å¤±è´¥ï¼ˆtokenåœ¨localStorageï¼Œä¸åœ¨cookieï¼‰
   â†’ è¿”å›æ— æ¸¸æˆæ•°æ®çš„é¡µé¢æ¨¡æ¿ï¼ˆmyHandJSON="null"ï¼‰

3. å‰ç«¯åŠ è½½é¡µé¢
   â†’ DOMContentLoaded äº‹ä»¶è§¦å‘
   â†’ loadGameDataFromAPI() è°ƒç”¨ /api/game/{id}/table
   â†’ APIè¿”å› status="waiting", myHand=null (å› ä¸ºstatus=waiting)
   â†’ renderGame() å°è¯• renderMyHand()
   â†’ âŒ é”™è¯¯: MY_HAND is null, cannot read 'cards'
```

**ä¿®å¤åçš„è°ƒç”¨é“¾**:
```
1. ç”¨æˆ·ç‚¹å‡»"å•äººæ¨¡å¼"
   â†’ POST /api/game/singleplayer (åˆ›å»ºæ¸¸æˆï¼ŒçŠ¶æ€=waiting)

2. é‡å®šå‘åˆ° GET /game/singleplayer/{id}
   â†’ SinglePlayerGamePageHandler æ‰§è¡Œ
   â†’ æ£€æŸ¥ç”¨æˆ·è®¤è¯ï¼ˆcookieï¼‰
   â†’ âŒ å¤±è´¥ï¼ˆtokenåœ¨localStorageï¼Œä¸åœ¨cookieï¼‰
   â†’ è¿”å›æ— æ¸¸æˆæ•°æ®çš„é¡µé¢æ¨¡æ¿ï¼ˆmyHandJSON="null"ï¼‰

3. å‰ç«¯åŠ è½½é¡µé¢
   â†’ DOMContentLoaded äº‹ä»¶è§¦å‘
   â†’ loadGameDataFromAPI() è°ƒç”¨ /api/game/{id}/table
   â†’ APIè¿”å› status="waiting", myHand=null (å› ä¸ºstatus=waiting)
   â†’ renderGame() æ£€æµ‹åˆ° status="waiting"
   â†’ âœ… è°ƒç”¨ autoStartSinglePlayerGame()
   â†’ POST /api/game/{id}/start-single (ä½¿ç”¨localStorage token)
   â†’ æ¸¸æˆå¯åŠ¨æˆåŠŸï¼ŒçŠ¶æ€å˜ä¸º "discarding"
   â†’ é‡æ–°è°ƒç”¨ loadGameDataFromAPI()
   â†’ APIè¿”å› status="discarding", myHand={...38 cards}
   â†’ âœ… renderGame() è°ƒç”¨ handleDiscardingPhase()
   â†’ âœ… æ‰‹ç‰Œæ­£ç¡®æ˜¾ç¤º
```

### å…³é”®æŠ€æœ¯ç‚¹

1. **çŠ¶æ€åˆ¤æ–­é€»è¾‘**: ä½¿ç”¨æ’é™¤æ³•ï¼ˆ!= waiting && != finishedï¼‰æ¯”æšä¸¾æ³•æ›´å¥å£®
2. **æ•°æ®å­—æ®µå‘½å**: Goçš„JSONåºåˆ—åŒ–é»˜è®¤ä½¿ç”¨å°å†™å­—æ®µåï¼ˆé™¤éæŒ‡å®štagï¼‰
3. **è®¤è¯æœºåˆ¶**: åç«¯æ”¯æŒHeaderå’ŒCookieåŒè®¤è¯ï¼Œå‰ç«¯åº”ä¼˜å…ˆä½¿ç”¨Header
4. **å¼‚æ­¥æµç¨‹**: è‡ªåŠ¨å¯åŠ¨æ¸¸æˆéœ€è¦ç­‰å¾…APIå“åº”åé‡æ–°åŠ è½½æ•°æ®

---

## ä»£ç å˜æ›´ç»Ÿè®¡

| æ–‡ä»¶ | ä¿®æ”¹è¡Œæ•° | æ–°å¢è¡Œæ•° | åˆ é™¤è¡Œæ•° |
|------|---------|---------|---------|
| handlers/handlers.go | 1 | 0 | 0 |
| templates/singleplayer_game.html | 5 | 43 | 0 |
| **æ€»è®¡** | **6** | **43** | **0** |

---

## åç»­å»ºè®®

### å»ºè®®æ”¹è¿›ï¼ˆå¯é€‰ï¼‰

1. **ç»Ÿä¸€è®¤è¯æœºåˆ¶**: è€ƒè™‘è®©åç«¯ä»localStorage tokenè‡ªåŠ¨è®¾ç½®cookie
2. **çŠ¶æ€å¸¸é‡åŒ–**: å®šä¹‰æ¸¸æˆçŠ¶æ€å¸¸é‡ï¼Œé¿å…ç¡¬ç¼–ç å­—ç¬¦ä¸²
3. **é”™è¯¯å¤„ç†å¢å¼º**: æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯æç¤ºå’Œé‡è¯•æœºåˆ¶
4. **è‡ªåŠ¨åŒ–æµ‹è¯•**: æ·»åŠ E2Eæµ‹è¯•è¦†ç›–å•äººæ¨¡å¼å¯åŠ¨æµç¨‹

### å·²éªŒè¯çš„åŠŸèƒ½

- âœ… æ¸¸æˆåˆ›å»º
- âœ… æ¸¸æˆè‡ªåŠ¨å¯åŠ¨
- âœ… æ‰‹ç‰Œæ•°æ®åŠ è½½
- âœ… æ‰‹ç‰Œæ¸²æŸ“
- âœ… åŸ‹åº•ç‰Œé€‰æ‹©äº¤äº’
- âœ… ä¸»ç‰Œæ˜¾ç¤º
- âœ… AIç©å®¶æ˜¾ç¤º

---

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤è§£å†³äº†å•äººæ¨¡å¼æ¸¸æˆçš„æ ¸å¿ƒé—®é¢˜ï¼Œä½¿æ¸¸æˆèƒ½å¤Ÿæ­£å¸¸å¯åŠ¨å’Œè¿›è¡Œã€‚ä¿®å¤è¿‡ç¨‹å‘ç°å¹¶è§£å†³äº†ï¼š
1. åç«¯çŠ¶æ€åˆ¤æ–­é€»è¾‘é”™è¯¯
2. å‰ç«¯æ•°æ®å­—æ®µå¤§å°å†™ä¸ä¸€è‡´
3. è®¤è¯æµç¨‹å¯¼è‡´çš„æ¸¸æˆæ— æ³•è‡ªåŠ¨å¯åŠ¨

æ‰€æœ‰ä¿®å¤å‡å·²é€šè¿‡æµè§ˆå™¨MCPè‡ªåŠ¨åŒ–æµ‹è¯•éªŒè¯ï¼Œæ¸¸æˆåŠŸèƒ½æ¢å¤æ­£å¸¸ã€‚

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2026-02-26 18:55
**æµ‹è¯•é€šè¿‡**: âœ…
**å¯ä»¥å‘å¸ƒ**: âœ…
