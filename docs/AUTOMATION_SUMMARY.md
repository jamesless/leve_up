# 自动化测试系统 - 完成总结

## 📋 系统概述

已创建完整的自动化测试系统，用于验证升级游戏的游戏逻辑。

## ✅ 完成的功能

### 1. 自动化游戏测试 (`automated_validator.go`)
- ✅ 自动创建并登录测试用户
- ✅ 运行3场完整的单人游戏（与4个AI玩家对战）
- ✅ 记录所有游戏事件到JSONL日志文件
- ✅ 自动控制游戏流程（自动出牌）
- ✅ 按版本号组织日志文件

### 2. 规则验证器 (`rule_validator.go`)
- ✅ 读取并解析游戏日志
- ✅ 验证发牌规则（162张牌，5玩家×31+7底牌）
- ✅ 验证出牌顺序（顺时针）
- ✅ 验证跟牌规则
- ✅ 验证计分规则（300分）
- ✅ 生成详细的验证报告
- ✅ 分类错误级别（error/warning/info）

### 3. 自动化运行脚本 (`automation_runner.sh`)
- ✅ 检查服务器状态
- ✅ 生成版本号（时间戳格式）
- ✅ 运行测试循环（最多10次迭代）
- ✅ 自动验证日志
- ✅ 如果通过，自动提交到git
- ✅ 如果失败，循环直到修复

### 4. 快速测试脚本 (`quick_test.sh`)
- ✅ 单次运行3场游戏
- ✅ 验证规则
- ✅ 不循环，适合快速验证

### 5. 配置文件
- ✅ `.gitignore` - 排除日志和临时文件
- ✅ `README_AUTOMATION.md` - 完整使用文档

## 📁 创建的文件

```
test/
├── automated_validator.go    # 主要测试引擎
├── rule_validator.go         # 规则验证器
├── automation_runner.sh      # 自动化循环脚本
├── quick_test.sh            # 快速测试脚本
└── README_AUTOMATION.md     # 使用文档

.leve_up/
├── .gitignore               # Git忽略配置
└── AUTOMATION_SUMMARY.md    # 本文件
```

## 🚀 使用方法

### 方法1: 完整自动化循环（推荐）
```bash
cd /Users/ken/my_project/leve_up/test
./automation_runner.sh
```

### 方法2: 快速单次测试
```bash
cd /Users/ken/my_project/leve_up/test
./quick_test.sh
```

### 方法3: 手动分步执行
```bash
# 1. 启动服务器
cd /Users/ken/my_project/leve_up
go run main.go

# 2. 在另一个终端运行测试
cd test
go run automated_validator.go

# 3. 验证日志
go run rule_validator.go log/v1.xxxxx
```

## 📊 日志结构

```
log/
└── v1.20240101_120000/          # 版本目录（时间戳）
    ├── combined_log.jsonl       # 所有事件（JSONL格式）
    ├── game_1.json              # 游戏1详细日志
    ├── game_2.json              # 游戏2详细日志
    └── game_3.json              # 游戏3详细日志
```

## 🎮 测试的游戏规则

### 发牌规则
- ✅ 5玩家，每人31张牌
- ✅ 底牌7张
- ✅ 总计162张（3副牌）
- ✅ 必须设置主牌花色

### 出牌规则
- ✅ 顺时针顺序（1→2→3→4→5→1）
- ✅ 必须跟首家花色
- ✅ 无花色可垫牌或毙牌
- ✅ 主牌可以毙副牌
- ✅ 王牌最大（大王>小王>主牌>副牌）

### 计分规则
- ✅ 5=5分, 10=10分, K=10分
- ✅ 总分300分
- ✅ 抠底倍数正确

## 🔄 工作流程

```
┌─────────────────┐
│  启动服务器      │
└────────┬────────┘
         ↓
┌─────────────────┐
│  生成版本号      │
└────────┬────────┘
         ↓
┌─────────────────┐
│  运行3场游戏     │
│  - 自动登录      │
│  - 创建游戏      │
│  - 记录日志      │
└────────┬────────┘
         ↓
┌─────────────────┐
│  验证规则        │
│  - 检查日志      │
│  - 对比规则      │
└────────┬────────┘
         ↓
    有错误？
    ↙  ↘
   是    否
   ↓     ↓
┌─────┐ ┌─────────┐
│修复  │ │提交代码  │
│重新  │ │完成！    │
│测试  │ └─────────┘
└──┬──┘
   └──> (回到测试)
```

## 📝 验证报告示例

### 成功
```
========================================
   规则验证报告
========================================
✅ 所有规则验证通过！
```

### 失败
```
========================================
   规则验证报告
========================================

📊 统计:
   错误: 2
   警告: 1

❌ 错误:

[1] 发牌规则 - 主牌设置
    发牌后未设置主牌花色
    💡 建议: 确保在发牌逻辑中正确设置主牌花色

[2] 计分规则 - 总分
    总分不等于300
    💡 建议: 检查分牌计算逻辑
```

## 🎯 下一步

1. **启动服务器并测试**
   ```bash
   cd /Users/ken/my_project/leve_up
   go run main.go
   ```

2. **在另一个终端运行快速测试**
   ```bash
   cd test
   ./quick_test.sh
   ```

3. **查看结果并修复问题**（如果有）

4. **所有测试通过后，运行完整循环**
   ```bash
   ./automation_runner.sh
   ```

## 📌 注意事项

1. **服务器依赖**: 必须先启动游戏服务器
2. **数据库**: 测试会创建新用户，会累积数据
3. **Git配置**: 确保已配置git用户信息
4. **日志清理**: 定期清理旧版本日志

## 🔧 自定义配置

### 修改游戏数量
编辑 `automated_validator.go`:
```go
for i := 1; i <= 3; i++ {  // 改为其他数字
```

### 修改最大迭代次数
编辑 `automation_runner.sh`:
```bash
MAX_ITERATIONS=10  # 改为其他数字
```

### 添加新规则
编辑 `rule_validator.go`:
```go
rv.Rules = append(rv.Rules, GameRule{
    Name: "新规则",
    Description: "描述",
    Category: "playing",
})
```

## ✨ 特性

- ✅ 完全自动化
- ✅ 版本化日志
- ✅ 详细的错误报告
- ✅ Git集成
- ✅ 可扩展架构
- ✅ JSON格式日志
- ✅ 彩色输出
- ✅ 错误分类

## 📞 支持

如有问题，查看：
- `test/README_AUTOMATION.md` - 详细使用文档
- 日志文件 - 具体的游戏事件
- 验证报告 - 规则违规详情

---

**创建时间**: 2026-02-26
**版本**: v1.0
**状态**: ✅ 完成
