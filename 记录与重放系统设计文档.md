# 五人三副牌找朋友升级游戏 - 完整游戏记录与重放系统

## 一、系统概述

本系统实现了完整的游戏操作日志记录和回放功能，可以记录游戏中的每一个操作，并支持用户查看历史游戏记录和重放游戏过程。

### 功能特性

✅ **操作日志记录** - 记录所有玩家操作（抢庄、扣牌、叫朋友、出牌等）
✅ **游戏重放** - 支持完整的游戏重放功能
✅ **历史记录查询** - 可查看所有历史游戏
✅ **详细数据存储** - 完整保存游戏初始状态和最终状态

---

## 二、数据库表设计

### 2.1 game_action_logs (游戏操作日志表)

记录游戏中每一个操作的详细信息。

```sql
CREATE TABLE IF NOT EXISTS game_action_logs (
    id SERIAL PRIMARY KEY,
    game_id VARCHAR(64) NOT NULL,           -- 游戏ID
    action_type VARCHAR(50) NOT NULL,       -- 操作类型
    player_seat INT NOT NULL,               -- 玩家座位号(1-5)
    player_id VARCHAR(64),                  -- 玩家ID
    action_data JSONB NOT NULL,             -- 操作详细数据
    result_data JSONB,                      -- 操作结果数据
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (game_id) REFERENCES games(id) ON DELETE CASCADE,
    FOREIGN KEY (player_id) REFERENCES users(id) ON DELETE SET NULL
);

CREATE INDEX idx_game_action_logs_game_id_timestamp
ON game_action_logs(game_id, timestamp);
```

**操作类型 (action_type) 列表：**
- `game_start` - 游戏开始
- `call_dealer` - 抢庄/叫庄
- `flip_bottom` - 翻底牌
- `discard_bottom` - 扣牌
- `call_friend` - 叫朋友
- `play_cards` - 出牌
- `trick_complete` - 一圈牌结束
- `game_end` - 游戏结束

### 2.2 game_replays (游戏重放表)

存储完整游戏的回放数据。

```sql
CREATE TABLE IF NOT EXISTS game_replays (
    id SERIAL PRIMARY KEY,
    game_id VARCHAR(64) UNIQUE NOT NULL,    -- 游戏ID
    initial_state JSONB NOT NULL,           -- 游戏初始状态
    final_state JSONB NOT NULL,             -- 游戏最终状态
    total_actions INT DEFAULT 0,            -- 总操作数
    duration_seconds INT DEFAULT 0,         -- 游戏时长(秒)
    winner_team VARCHAR(20),                -- 获胜方(dealer/attacker)
    final_score INT DEFAULT 0,              -- 最终分数
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (game_id) REFERENCES games(id) ON DELETE CASCADE
);
```

---

## 三、完整游戏流程与操作记录

### 示例游戏记录

**游戏ID**: `1772076xxx`
**开始时间**: `2026-02-26 11:15:30`
**游戏时长**: `15分30秒`
**总操作数**: `87次`

### 3.1 游戏初始化阶段

| 序号 | 时间 | 操作类型 | 玩家 | 操作详情 | 结果 |
|------|------|----------|------|----------|------|
| 1 | 00:00.000 | game_start | Host | 游戏创建，5名玩家加入 | 成功 |
| 2 | 00:00.150 | deal_cards | System | 发牌：每人31张，底牌7张 | 完成 |
| 3 | 00:00.200 | determine_dealer | System | 随机确定起始发牌人：座位3 | 完成 |

**action_data 示例**:
```json
{
  "starting_dealer": 3,
  "current_level": "2",
  "player_count": 5,
  "trump_rank": "2"
}
```

### 3.2 抢庄阶段

| 序号 | 时间 | 操作类型 | 玩家 | 操作详情 | 结果 |
|------|------|----------|------|----------|------|
| 4 | 00:02.500 | call_dealer | 座位1 | 亮主：♥2（单张） | 成功 |
| 5 | 00:04.200 | call_dealer | 座位3 | 反主：♥2（对子） | 成功，成为庄家 |
| 6 | 00:09.800 | countdown_end | System | 抢庄倒计时结束 | 庄家确定为座位3 |

**action_data 示例**:
```json
{
  "suit": "hearts",
  "rank": "2",
  "count": 2,
  "card_indices": [5, 12]
}
```

**result_data 示例**:
```json
{
  "dealer_seat": 3,
  "trump_suit": "hearts",
  "trump_rank": "2"
}
```

### 3.3 扣牌阶段

| 序号 | 时间 | 操作类型 | 玩家 | 操作详情 | 结果 |
|------|------|----------|------|----------|------|
| 7 | 00:10.000 | take_bottom | 座位3 | 庄家收取7张底牌 | 手牌变为38张 |
| 8 | 00:15.500 | discard_bottom | 座位3 | 扣牌：选择7张牌扣回底牌 | 成功，手牌变为31张 |

**action_data 示例**:
```json
{
  "card_indices": [0, 3, 7, 15, 22, 28, 35],
  "discarded_cards": [
    {"suit": "clubs", "value": "3"},
    {"suit": "clubs", "value": "4"},
    {"suit": "diamonds", "value": "6"},
    {"suit": "diamonds", "value": "7"},
    {"suit": "spades", "value": "8"},
    {"suit": "spades", "value": "9"},
    {"suit": "clubs", "value": "J"}
  ]
}
```

### 3.4 叫朋友阶段

| 序号 | 时间 | 操作类型 | 玩家 | 操作详情 | 结果 |
|------|------|----------|------|----------|------|
| 9 | 00:16.000 | call_friend | 座位3 | 叫朋友：♠A | 等待朋友出现 |

**action_data 示例**:
```json
{
  "suit": "spades",
  "value": "A",
  "called_card": "♠A"
}
```

**特殊情况检测**:
```json
{
  "is_solo_mode": false,
  "card_in_dealer_hand": false,
  "card_in_bottom": false
}
```

### 3.5 出牌阶段（部分记录）

#### 第1轮（第1圈）

| 序号 | 时间 | 操作类型 | 玩家 | 操作详情 | 结果 |
|------|------|----------|------|----------|------|
| 10 | 00:18.000 | play_cards | 座位3 | 领出：♥9（单张） | 成功 |
| 11 | 00:20.200 | play_cards | 座位4 | 跟牌：♥7（单张） | 成功 |
| 12 | 00:22.500 | play_cards | 座位5 | 跟牌：♥K（单张） | 成功 |
| 13 | 00:24.800 | play_cards | 座位1 | 跟牌：♥Q（单张） | 成功 |
| 14 | 00:27.100 | play_cards | 座位2 | 跟牌：♥3（单张） | 成功 |
| 15 | 00:27.200 | trick_complete | System | 一圈结束，座位5获胜（♥K最大） | 座位5得分：0分 |

**play_cards action_data 示例**:
```json
{
  "card_indices": [8],
  "cards": [{"suit": "hearts", "value": "9"}],
  "is_lead": true,
  "play_type": "single"
}
```

**trick_complete result_data 示例**:
```json
{
  "winner_seat": 5,
  "winning_card": {"suit": "hearts", "value": "K"},
  "points_collected": 0,
  "next_leader": 5
}
```

#### 第2轮（第2圈）- 包含分值牌

| 序号 | 时间 | 操作类型 | 玩家 | 操作详情 | 结果 |
|------|------|----------|------|----------|------|
| 16 | 00:29.000 | play_cards | 座位5 | 领出：♠10（单张，10分） | 成功 |
| 17 | 00:31.200 | play_cards | 座位1 | 跟牌：♠6（单张） | 成功 |
| 18 | 00:33.500 | play_cards | 座位2 | 跟牌：♠K（单张，10分） | 成功 |
| 19 | 00:35.800 | play_cards | 座位3 | 跟牌：♠2（单张） | 成功 |
| 20 | 00:38.100 | play_cards | 座位4 | 跟牌：♠A（单张） | 成功 |
| 21 | 00:38.200 | trick_complete | System | 一圈结束，座位4获胜（♠A最大） | 座位4得分：20分（10+10） |

#### 第15轮 - 拖拉机出牌

| 序号 | 时间 | 操作类型 | 玩家 | 操作详情 | 结果 |
|------|------|----------|------|----------|------|
| 58 | 05:32.500 | play_cards | 座位2 | 领出：♦J对+♦Q对（拖拉机） | 成功 |
| 59 | 05:35.200 | play_cards | 座位3 | 跟牌：♥5对+♥6对（主牌拖拉机） | 成功，毙牌 |
| 60 | 05:37.800 | play_cards | 座位4 | 跟牌：♦K对+♦A对（拖拉机） | 成功 |
| 61 | 05:40.300 | play_cards | 座位5 | 跟牌：♣9对+♣10对（副牌垫牌） | 成功 |
| 62 | 05:42.600 | play_cards | 座位1 | 跟牌：♥8对+♥9对（主牌拖拉机） | 成功，更大 |
| 63 | 05:42.700 | trick_complete | System | 一圈结束，座位1获胜（主牌拖拉机最大） | 座位1得分：20分 |

**tractor play_cards action_data**:
```json
{
  "card_indices": [10, 11, 15, 16],
  "cards": [
    {"suit": "diamonds", "value": "J"},
    {"suit": "diamonds", "value": "J"},
    {"suit": "diamonds", "value": "Q"},
    {"suit": "diamonds", "value": "Q"}
  ],
  "is_lead": true,
  "play_type": "tractor",
  "tractor_length": 2
}
```

#### 第20轮 - 连三拖拉机（BUG-003修复后支持）

| 序号 | 时间 | 操作类型 | 玩家 | 操作详情 | 结果 |
|------|------|----------|------|----------|------|
| 78 | 08:15.000 | play_cards | 座位4 | 领出：♣8三+♣9三（连三拖拉机） | 成功 |
| 79 | 08:18.500 | play_cards | 座位5 | 跟牌：♥10三+♥J三（主牌连三） | 成功，毙牌 |

**triple_tractor play_cards action_data**:
```json
{
  "card_indices": [5, 6, 7, 12, 13, 14],
  "cards": [
    {"suit": "clubs", "value": "8"},
    {"suit": "clubs", "value": "8"},
    {"suit": "clubs", "value": "8"},
    {"suit": "clubs", "value": "9"},
    {"suit": "clubs", "value": "9"},
    {"suit": "clubs", "value": "9"}
  ],
  "is_lead": true,
  "play_type": "triple_tractor",
  "tractor_length": 2,
  "cards_per_group": 3
}
```

### 3.6 抠底阶段

| 序号 | 时间 | 操作类型 | 玩家 | 操作详情 | 结果 |
|------|------|----------|------|----------|------|
| 85 | 15:20.000 | last_trick_start | System | 最后一圈开始 | 检测抠底 |
| 86 | 15:28.500 | trick_complete | 座位1 | 最后一圈，座位1获胜（对子抠底） | 底牌分×2计入座位1 |

**bottom_multiplier calculation**:
```json
{
  "lead_cards": [
    {"suit": "hearts", "value": "A"},
    {"suit": "hearts", "value": "A"}
  ],
  "multiplier": 2,
  "reason": "对子抠底",
  "bottom_points": 30,
  "final_points": 60
}
```

### 3.7 游戏结束阶段

| 序号 | 时间 | 操作类型 | 玩家 | 操作详情 | 结果 |
|------|------|----------|------|----------|------|
| 87 | 15:30.000 | game_end | System | 游戏结束，计算得分和升级 | 抓分方获胜 |

**game_end result_data**:
```json
{
  "winner_team": "attacker",
  "dealer_team": [3, 5],
  "attacker_team": [1, 2, 4],
  "final_score": 185,
  "dealer_score": 0,
  "attacker_score": 185,
  "is_solo_mode": false,
  "level_changes": [
    {"user_id": "player1", "old_level": "2", "new_level": "4", "change": "+2"},
    {"user_id": "player2", "old_level": "2", "new_level": "4", "change": "+2"},
    {"user_id": "player3", "old_level": "2", "new_level": "2", "change": "0"},
    {"user_id": "player4", "old_level": "2", "new_level": "4", "change": "+2"},
    {"user_id": "player5", "old_level": "2", "new_level": "2", "change": "0"}
  ],
  "upgrade_table_used": "2v3",
  "score_range": "180-239",
  "upgrade_amount": 2
}
```

---

## 四、已修复的关键Bug记录

### 4.1 BUG-001: 分值牌定义矛盾 ✅ 已修复

**修复前**:
- 只有黑桃的5、10、K是分值牌
- 总分75分，不符合300分规则

**修复后**:
- 所有花色的5、10、K都是分值牌
- 总分：(5+10+10) × 4花色 × 3副 = **300分** ✓

**影响的日志记录**:
```json
{
  "action_type": "trick_complete",
  "points_collected": 25,
  "scoring_cards": [
    {"suit": "hearts", "value": "5", "points": 5},
    {"suit": "diamonds", "value": "10", "points": 10},
    {"suit": "clubs", "value": "K", "points": 10}
  ]
}
```

### 4.2 BUG-003: 连三拖拉机支持 ✅ 已修复

**修复前**: 只支持连对（pair tractor）

**修复后**: 支持连三（triple tractor）

**日志记录示例**:
```json
{
  "action_type": "play_cards",
  "play_type": "triple_tractor",
  "tractor_length": 2,
  "cards_per_group": 3,
  "cards": [
    {"suit": "clubs", "value": "8"},
    {"suit": "clubs", "value": "8"},
    {"suit": "clubs", "value": "8"},
    {"suit": "clubs", "value": "9"},
    {"suit": "clubs", "value": "9"},
    {"suit": "clubs", "value": "9"}
  ]
}
```

### 4.3 BUG-004: 1打4模式检测 ✅ 已修复

**修复后日志记录**:
```json
{
  "action_type": "call_friend",
  "called_card": {"suit": "spades", "value": "A"},
  "detection_result": {
    "is_solo_mode": true,
    "reason": "card_in_dealer_hand",
    "friend_seat": 3,
    "game_mode": "1v4"
  }
}
```

### 4.4 BUG-005: 升级反庄家转移 ✅ 已修复

**日志记录示例**:
```json
{
  "action_type": "call_dealer",
  "call_type": "upgrade_counter",
  "old_dealer": 3,
  "new_dealer": 5,
  "old_rank": "2",
  "new_rank": "3",
  "result": {
    "dealer_changed": true,
    "new_dealer_seat": 5,
    "new_trump_rank": "3",
    "new_trump_suit": "diamonds"
  }
}
```

---

## 五、游戏重放系统

### 5.1 重放数据存储

**initial_state** (游戏初始状态):
```json
{
  "game_id": "1772076xxx",
  "players": [
    {"seat": 1, "user_id": "player1", "username": "张三", "level": "2"},
    {"seat": 2, "user_id": "player2", "username": "李四", "level": "2"},
    {"seat": 3, "user_id": "player3", "username": "王五", "level": "3"},
    {"seat": 4, "user_id": "player4", "username": "赵六", "level": "2"},
    {"seat": 5, "user_id": "player5", "username": "孙七", "level": "2"}
  ],
  "starting_dealer": 3,
  "trump_rank": "2",
  "hands": {
    "1": [/* 31张牌 */],
    "2": [/* 31张牌 */],
    "3": [/* 31张牌 */],
    "4": [/* 31张牌 */],
    "5": [/* 31张牌 */]
  },
  "bottom_cards": [/* 7张牌 */]
}
```

**final_state** (游戏最终状态):
```json
{
  "winner_team": "attacker",
  "final_score": 185,
  "dealer_seat": 3,
  "friend_seat": 5,
  "is_solo_mode": false,
  "trump_suit": "hearts",
  "trump_rank": "2",
  "level_changes": [
    {"seat": 1, "old_level": "2", "new_level": "4"},
    {"seat": 2, "old_level": "2", "new_level": "4"},
    {"seat": 3, "old_level": "3", "new_level": "3"},
    {"seat": 4, "old_level": "2", "new_level": "4"},
    {"seat": 5, "old_level": "2", "new_level": "2"}
  ],
  "total_tricks": 31,
  "duration_seconds": 930
}
```

### 5.2 重放API接口

#### 获取游戏重放列表
```http
GET /api/replays?limit=20&offset=0
```

**Response**:
```json
{
  "replays": [
    {
      "id": 1,
      "game_id": "1772076xxx",
      "winner_team": "attacker",
      "final_score": 185,
      "total_actions": 87,
      "duration_seconds": 930,
      "created_at": "2026-02-26T11:15:30Z"
    }
  ],
  "total": 150
}
```

#### 获取游戏详细重放数据
```http
GET /api/replays/:game_id
```

**Response**:
```json
{
  "replay": {
    "game_id": "1772076xxx",
    "initial_state": { /* ... */ },
    "final_state": { /* ... */ },
    "actions": [ /* 87个操作记录 */ ]
  }
}
```

#### 获取游戏操作日志
```http
GET /api/games/:game_id/actions
```

**Response**:
```json
{
  "actions": [
    {
      "id": 1,
      "action_type": "game_start",
      "player_seat": 0,
      "action_data": { /* ... */ },
      "result_data": { /* ... */ },
      "timestamp": "2026-02-26T11:15:30.000Z"
    },
    /* ... 更多操作 */
  ]
}
```

---

## 六、前端重放界面设计

### 6.1 历史记录页面

```
┌─────────────────────────────────────────────────┐
│  游戏历史记录                                    │
├─────────────────────────────────────────────────┤
│                                                 │
│  [筛选] 日期: [____]  结果: [全部▼]  等级: [____] │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ 2026-02-26 11:15  游戏ID: 1772076xxx  │   │
│  │ 时长: 15分30秒  操作数: 87            │   │
│  │ 庄家: 王五(座位3) | 朋友: 孙七(座位5)  │   │
│  │ 结果: 抓分方获胜 (185分)              │   │
│  │ [查看回放] [查看详情]                  │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ 2026-02-26 10:45  游戏ID: 1772074xxx  │   │
│  │ 时长: 12分15秒  操作数: 73            │   │
│  │ 庄家: 李四(座位2) | 模式: 1打4        │   │
│  │ 结果: 庄家获胜 (55分)                 │   │
│  │ [查看回放] [查看详情]                  │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 6.2 游戏重放界面

```
┌───────────────────────────────────────────────────┐
│  游戏回放 - ID: 1772076xxx                        │
├───────────────────────────────────────────────────┤
│                                                   │
│  [◀◀] [◀] [▶] [▶▶]  速度: [1x▼]  操作 #45/87    │
│  ━━━━━━━━━━━━━━●━━━━━━━━━━━━━ 05:32 / 15:30    │
│                                                   │
│  ┌─────────────────────────────────────────┐     │
│  │        当前状态: 第15轮出牌              │     │
│  │                                         │     │
│  │     座位2(领出): ♦J♦J ♦Q♦Q (拖拉机)    │     │
│  │                                         │     │
│  │     [牌桌中央显示]                      │     │
│  │                                         │     │
│  │  座位3(庄):♥5♥5 ♥6♥6  得分: 85分      │     │
│  │  座位5(友):手牌显示     得分: 0分      │     │
│  │                                         │     │
│  └─────────────────────────────────────────┘     │
│                                                   │
│  ┌─────────────────────────────────────────┐     │
│  │  操作日志                               │     │
│  │  --------------------------------       │     │
│  │  #43: 座位1出牌 ♥8♥8 ♥9♥9              │     │
│  │  #44: 座位2领出 ♦J♦J ♦Q♦Q (拖拉机)     │     │
│  │  #45: 座位3跟牌 ♥5♥5 ♥6♥6 (主牌杀)     │ ◀   │
│  │  #46: ...                               │     │
│  └─────────────────────────────────────────┘     │
│                                                   │
│  [跳转到抢庄] [跳转到扣牌] [跳转到抠底] [导出]   │
│                                                   │
└───────────────────────────────────────────────────┘
```

---

## 七、统计与分析

### 7.1 游戏统计数据

可以基于game_action_logs表进行各种统计分析：

```sql
-- 统计玩家平均出牌时间
SELECT
    player_id,
    AVG(EXTRACT(EPOCH FROM (timestamp - LAG(timestamp) OVER (ORDER BY timestamp)))) as avg_time
FROM game_action_logs
WHERE action_type = 'play_cards'
GROUP BY player_id;

-- 统计拖拉机出牌频率
SELECT
    COUNT(*) as tractor_count,
    COUNT(*) FILTER (WHERE action_data->>'play_type' = 'triple_tractor') as triple_count
FROM game_action_logs
WHERE action_type = 'play_cards'
  AND action_data->>'play_type' IN ('tractor', 'triple_tractor');

-- 统计抠底成功率
SELECT
    winner_team,
    COUNT(*) as games,
    AVG(final_score) as avg_score
FROM game_replays
GROUP BY winner_team;
```

---

## 八、实现要点总结

✅ **数据库表设计** - 完成game_action_logs和game_replays表
✅ **日志记录功能** - 在game.go中添加LogGameAction调用
✅ **重放数据结构** - 定义完整的JSON数据格式
✅ **API接口设计** - 获取重放列表和详细数据的API
✅ **前端界面设计** - 历史记录和重放播放器UI设计

### 关键技术点

1. **JSONB存储** - 使用PostgreSQL的JSONB类型存储灵活的游戏数据
2. **时间戳索引** - 为高效查询创建复合索引
3. **级联删除** - 游戏删除时自动清理相关日志
4. **状态快照** - 保存完整的初始和最终状态用于回放

---

## 九、后续优化方向

🔜 **性能优化** - 大量历史记录的分页和缓存
🔜 **数据压缩** - 对JSONB数据进行压缩存储
🔜 **实时同步** - WebSocket实时推送游戏状态给观战者
🔜 **视频导出** - 将游戏重放导出为视频文件
🔜 **AI分析** - 基于历史数据进行牌局分析和建议

---

**文档版本**: v1.0
**最后更新**: 2026-02-26
**维护者**: 开发团队
