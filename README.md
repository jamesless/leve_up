# 升级 - 五人三副牌找朋友

经典中国扑克牌游戏「升级」，支持五人三副牌找朋友玩法。

## 项目结构

```text
leve_up/
├── backend/          # Go 后端
│   ├── main.go       # 入口文件
│   ├── handlers/     # API 路由处理
│   ├── middleware/   # 鉴权中间件
│   ├── models/       # 数据模型与游戏逻辑
│   ├── scripts/      # 初始化脚本
│   └── test/         # 后端测试与验证脚本
├── frontend/         # React 前端
│   ├── src/
│   │   ├── components/
│   │   ├── hooks/
│   │   ├── lib/
│   │   ├── routes/
│   │   ├── services/
│   │   ├── store/
│   │   └── types/
│   └── ...config files
└── RULE.md           # 详细游戏规则文档
```

## 详细规则说明

- 完整规则请查看 `RULE.md`
- 建议按顺序阅读：基础术语 → 叫庄/反庄 → 找朋友 → 出牌判定 → 计分升级
- `README.md` 仅保留运行与开发说明，规则以 `RULE.md` 为准

## 核心规则概念

### 牌等级系统

升级游戏中的牌不是简单按点数排序，而是根据当前打的级别和主花色形成**动态等级系统**：

#### 主牌等级序列（从大到小）

```
大王 > 小王 > 主级牌 > 副级牌 > 主A > 主K > 主Q > ... > 主3 > 主2
```

**示例**：假设打 5 级，主花色是红桃

| 牌 | 等级 | 说明 |
|-----|------|------|
| 大王 | 1000 | 最大的牌 |
| 小王 | 900 | 第二大 |
| 红桃5 | 800 | 主级牌（主花色的级牌） |
| 黑桃5 | 703 | 副级牌（其他花色的级牌） |
| 方片5 | 701 | 副级牌（其他花色的级牌） |
| 梅花5 | 700 | 副级牌（其他花色的级牌） |
| 红桃A | 614 | 主花色牌中最大的非级牌 |
| 红桃K | 613 | 主花色牌 |
| ... | ... | ... |
| 红桃3 | 603 | 主花色牌中最小的 |

#### 副牌等级序列（从大到小）

副牌中，**级牌被排除**，其余牌按点数排序：

```
A(14) > K(13) > Q(12) > J(11) > 10(10) > 9(9) > 8(8) > 7(7) > 6(6) > 4(4) > 3(3) > 2(2)
```

**示例**：打 5 级时的黑桃副牌序列

```
黑桃A(14) > 黑桃K(13) > ... > 黑桃6(6) > 黑桃4(4) > 黑桃3(3) > 黑桃2(2)
注意：黑桃5 是级牌，不在副牌序列中
```

### 拖拉机规则（级牌跳过）

**核心原则**：拖拉机是按照**牌的等级连续**，而非仅按点数连续。

#### 规则要点

1. **主牌拖拉机**：按主牌等级序列判断连续性
2. **副牌拖拉机**：级牌被跳过，前后牌视为连续
3. **牌型匹配**：对子只能被对子管上，三张只能被三张管上

#### 示例（打 5 级，主花色红桃）

| 组合 | 是否为拖拉机 | 说明 |
|------|-------------|------|
| 黑桃4对 + 黑桃6对 | ✅ 是 | 副牌序列中，4和6连续（5是级牌被跳过） |
| 黑桃3对 + 黑桃4对 + 黑桃6对 | ✅ 是 | 3-4-6连续（跳过5） |
| 黑桃4对 + 黑桃5对 | ❌ 否 | 黑桃5是级牌，不在副牌序列中 |
| 红桃4对 + 红桃6对 | ✅ 是 | 主牌序列中，主4(604)和主6(606)连续 |
| 红桃A对 + 红桃K对 + 红桃Q对 | ✅ 是 | 主牌序列连续 |

#### 等级差计算规则

**副牌拖拉机判断**：
- 如果级牌在两张牌之间：点数差 = 2（跳过级牌）
- 否则：点数差 = 1（正常连续）

**主牌拖拉机判断**：
- 按照主牌等级值连续（每次等级+1）

#### 实际游戏示例

**场景：打 5 级，主花色红桃**

```
玩家手牌包含：
- 黑桃对4、黑桃对6、黑桃对7
- 红桃对3、红桃对4、红桃对6

可以组成的拖拉机：
✅ 黑桃对4 + 黑桃对6 + 黑桃对7（副牌3连对，4-6-7连续，跳过5）
✅ 红桃对3 + 红桃对4 + 红桃对6（主牌3连对，等级603-604-606连续）
```

### 关键技术实现

在代码中，我们通过以下方式实现等级系统：

```go
// 计算牌的游戏等级
func getCardRank(card Card, trumpSuit, trumpRank string) int {
    // 1. 大王 = 1000
    // 2. 小王 = 900
    // 3. 主级牌 = 800
    // 4. 副级牌 = 700-703
    // 5. 主花色牌 = 600 + 点数
    // 6. 副牌 = 点数
}

// 验证拖拉机时考虑级牌跳过
func validateTractor(cards []Card, table *GameTable) error {
    // 按等级排序
    // 检查等级连续性
    // 副牌需要考虑级牌跳过的情况
}
```

### 更多规则细节

完整的游戏规则（叫庄、反庄、找朋友、计分等）请参考 `RULE.md`

## 技术栈

### 后端 (`backend/`)

| 技术       | 用途     |
| ---------- | -------- |
| Go 1.21    | 编程语言 |
| Gin        | Web 框架 |
| PostgreSQL | 数据库   |
| JWT        | 用户认证 |

### 前端 (`frontend/`)

| 技术                  | 用途           |
| --------------------- | -------------- |
| React 18              | UI 框架        |
| Vite                  | 构建工具       |
| TypeScript            | 类型安全       |
| Tailwind CSS          | 样式           |
| shadcn/ui             | UI 组件库      |
| TanStack React Query  | 服务端状态管理 |
| Zustand               | 客户端状态管理 |
| React Router v7       | 路由           |

## 快速开始

### 一键初始化（推荐）

```bash
./scripts/bootstrap.sh
```

该命令会自动完成：

- 校验 Go / Node / PostgreSQL 客户端
- 准备 pnpm（通过 corepack）
- 初始化本地数据库与权限
- 安装 backend/frontend 依赖
- 构建 frontend 产物
- 自动将可运行默认值注入 `backend/.env`

### 环境要求

- Go 1.21+
- Node.js 20+
- PostgreSQL

### 1) 初始化数据库（首次）

```bash
cd backend
cp .env.example .env

# 按需修改 DB_USER / DB_PASSWORD / DB_NAME 后执行
source .env
./scripts/init_local_db.sh
```

### 2) 启动后端 API

```bash
cd backend
source .env
go run .
```

后端默认运行在 `http://localhost:8080`。

### 3) 启动前端（开发模式）

```bash
cd frontend
npm install
npm run dev
```

前端默认运行在 `http://localhost:5173`，并代理 `/api` 到后端。

### 4) 构建前端（生产模式）

```bash
cd frontend
npm run build
```

构建产物输出到 `frontend/dist/`。

### 5) 生产链路（后端托管前端）

```bash
cd frontend && npm run build
cd ../backend && source .env && go run .
```

- 后端会直接返回 `frontend/dist/index.html`
- 前端路由（如 `/login`、`/game/replay/:id`）由 React Router 接管
- API 仍由 `/api/*` 提供

## API 概览

### 认证

| 方法 | 路径            | 说明         |
| ---- | --------------- | ------------ |
| POST | `/api/register` | 注册         |
| POST | `/api/login`    | 登录         |
| POST | `/api/logout`   | 退出         |
| GET  | `/api/user`     | 获取当前用户 |

### 游戏

| 方法 | 路径                    | 说明         |
| ---- | ----------------------- | ------------ |
| POST | `/api/game/create`      | 创建房间     |
| POST | `/api/game/singleplayer`| 创建单人游戏 |
| GET  | `/api/game/:id`         | 获取游戏信息 |
| GET  | `/api/game/:id/table`   | 获取牌桌状态 |
| POST | `/api/game/:id/join`    | 加入房间     |
| POST | `/api/game/:id/start`   | 开始游戏     |
| POST | `/api/game/:id/play`    | 出牌         |
| POST | `/api/game/:id/ai-play` | AI 出牌      |
| GET  | `/api/game/:id/replay`  | 获取回放信息 |
| GET  | `/api/game/:id/actions` | 获取动作历史 |

## 开发规范

详见 `AGENTS.md`。
