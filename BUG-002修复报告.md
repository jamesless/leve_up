# BUG-002 ä¿®å¤æŠ¥å‘Šï¼šæ‹–æ‹‰æœºç­‰çº§ç³»ç»Ÿ

**ç”Ÿæˆæ—¶é—´**ï¼š2026-02-26
**ä¿®å¤å†…å®¹**ï¼šå®Œæ•´çš„ç‰Œç­‰çº§ç³»ç»Ÿï¼Œæ”¯æŒçº§ç‰Œè·³è¿‡è§„åˆ™
**ä¿®å¤æ–‡ä»¶**ï¼š`backend/models/game.go`

---

## é—®é¢˜æè¿°

### åŸé—®é¢˜ï¼ˆBUG-002ï¼‰

**ä¸¥é‡ç¨‹åº¦**ï¼šğŸ”´ ä¸¥é‡ï¼ˆæ¸¸æˆè§„åˆ™æœ€æ ¸å¿ƒçš„é—®é¢˜ï¼‰

**é—®é¢˜**ï¼š
- æ‹–æ‹‰æœºéªŒè¯ä½¿ç”¨ç®€å•çš„æ•°å€¼è¿ç»­æ€§æ£€æŸ¥
- æ— æ³•æ­£ç¡®å¤„ç†çº§ç‰Œè·³è¿‡çš„æƒ…å†µ
- ä¾‹å¦‚ï¼šæ‰“5çº§æ—¶ï¼Œå‰¯ç‰Œ4å¯¹+6å¯¹åº”è¯¥æ˜¯æœ‰æ•ˆæ‹–æ‹‰æœºï¼ˆè·³è¿‡5ï¼‰ï¼Œä½†ç°æœ‰ä»£ç ä¼šæ‹’ç»

**é”™è¯¯ä»£ç ç‰‡æ®µ**ï¼š
```go
// æ—§ä»£ç  - ç®€å•çš„æ•°å€¼æ¯”è¾ƒ
for i := 1; i < len(values); i++ {
    prevValue := getCardNumericValue(values[i-1])
    currValue := getCardNumericValue(values[i])
    if currValue != prevValue+1 {
        return fmt.Errorf("tractor values must be consecutive (e.g., 10-J-Q)")
    }
}
```

---

## ä¿®å¤æ–¹æ¡ˆ

### 1. å®ç°å®Œæ•´çš„ç‰Œç­‰çº§ç³»ç»Ÿ

æ–°å¢ `getCardRank()` å‡½æ•°ï¼Œè®¡ç®—ç‰Œåœ¨æ¸¸æˆä¸­çš„çœŸå®ç­‰çº§ï¼š

```go
// getCardRank è®¡ç®—ç‰Œåœ¨æ¸¸æˆä¸­çš„ç­‰çº§ï¼Œè€ƒè™‘ä¸»ç‰Œã€çº§ç‰Œç­‰ç‰¹æ®Šè§„åˆ™
// è¿”å›å€¼è¶Šå¤§ï¼Œç‰Œçš„ç­‰çº§è¶Šé«˜
func getCardRank(card Card, trumpSuit, trumpRank string) int {
    // 1. å¤§ç‹ = 1000
    if card.Type == "joker" && card.Value == "big" {
        return 1000
    }

    // 2. å°ç‹ = 900
    if card.Type == "joker" && card.Value == "small" {
        return 900
    }

    // 3. ä¸»çº§ç‰Œï¼ˆä¸»èŠ±è‰²çš„çº§ç‰Œï¼‰= 800
    if card.Value == trumpRank && card.Suit == trumpSuit {
        return 800
    }

    // 4. å‰¯çº§ç‰Œï¼ˆå…¶ä»–èŠ±è‰²çš„çº§ç‰Œï¼‰= 700-703
    // æŒ‰èŠ±è‰²é¡ºåºï¼šspades > hearts > diamonds > clubs
    if card.Value == trumpRank {
        suitOrder := map[string]int{
            "spades":   3,
            "hearts":   2,
            "diamonds": 1,
            "clubs":    0,
        }
        return 700 + suitOrder[card.Suit]
    }

    // 5. ä¸»èŠ±è‰²ç‰Œï¼ˆéçº§ç‰Œï¼‰= 600 + åŸºç¡€å€¼
    // ä¾‹å¦‚ï¼šä¸»A = 614ï¼Œä¸»K = 613ï¼Œ...ï¼Œä¸»3 = 603
    if card.Suit == trumpSuit {
        baseValues := map[string]int{
            "2": 2, "3": 3, "4": 4, "5": 5, "6": 6, "7": 7, "8": 8, "9": 9, "10": 10,
            "J": 11, "Q": 12, "K": 13, "A": 14,
        }
        return 600 + baseValues[card.Value]
    }

    // 6. å‰¯ç‰Œï¼ˆéçº§ç‰Œï¼‰= åŸºç¡€å€¼
    // ä¾‹å¦‚ï¼šå‰¯A = 14ï¼Œå‰¯K = 13ï¼Œ...ï¼Œå‰¯3 = 3ï¼Œå‰¯2 = 2
    baseValues := map[string]int{
        "2": 2, "3": 3, "4": 4, "5": 5, "6": 6, "7": 7, "8": 8, "9": 9, "10": 10,
        "J": 11, "Q": 12, "K": 13, "A": 14,
    }
    return baseValues[card.Value]
}
```

**ç‰Œç­‰çº§ä½“ç³»**ï¼š
| ç‰Œç±»å‹ | ç­‰çº§èŒƒå›´ | è¯´æ˜ |
|--------|---------|------|
| å¤§ç‹ | 1000 | æœ€å¤§çš„ç‰Œ |
| å°ç‹ | 900 | ç¬¬äºŒå¤§ |
| ä¸»çº§ç‰Œ | 800 | ä¸»èŠ±è‰²çš„çº§ç‰Œï¼ˆå¦‚æ‰“2çº§ä¸”ä¸»èŠ±è‰²æ˜¯çº¢æ¡ƒï¼Œåˆ™çº¢æ¡ƒ2ï¼‰ |
| å‰¯çº§ç‰Œ | 700-703 | å…¶ä»–èŠ±è‰²çš„çº§ç‰Œï¼ŒæŒ‰èŠ±è‰²æ’åº |
| ä¸»èŠ±è‰²ç‰Œ | 600-614 | ä¸»èŠ±è‰²çš„éçº§ç‰Œï¼ˆAæœ€å¤§=614ï¼Œ3æœ€å°=603ï¼‰ |
| å‰¯ç‰Œ | 2-14 | éä¸»èŠ±è‰²çš„éçº§ç‰Œï¼ˆAæœ€å¤§=14ï¼Œ2æœ€å°=2ï¼‰ |

---

### 2. é‡å†™æ‹–æ‹‰æœºéªŒè¯é€»è¾‘

ä¿®æ”¹ `validateTractor()` å‡½æ•°ï¼Œä½¿ç”¨æ–°çš„ç­‰çº§ç³»ç»Ÿï¼š

**å…³é”®æ”¹è¿›**ï¼š

1. **æ·»åŠ  `table *GameTable` å‚æ•°**ï¼š
   ```go
   // æ—§ç­¾å
   func validateTractor(cards []Card) error

   // æ–°ç­¾å
   func validateTractor(cards []Card, table *GameTable) error
   ```

2. **ä½¿ç”¨ `getCardRank()` æ’åº**ï¼š
   ```go
   // æŒ‰æ¸¸æˆç­‰çº§æ’åºï¼Œè€Œä¸æ˜¯æŒ‰æ•°å€¼æ’åº
   sort.Slice(uniqueCards, func(i, j int) bool {
       rankI := getCardRank(uniqueCards[i], table.TrumpSuit, table.TrumpRank)
       rankJ := getCardRank(uniqueCards[j], table.TrumpSuit, table.TrumpRank)
       return rankI < rankJ
   })
   ```

3. **æ­£ç¡®å¤„ç†çº§ç‰Œè·³è¿‡**ï¼š
   ```go
   // æ£€æŸ¥è¿ç»­æ€§æ—¶è€ƒè™‘çº§ç‰Œè·³è¿‡
   if currRank >= 600 && prevRank >= 600 {
       // ä¸»ç‰Œï¼šç­‰çº§å¿…é¡»è¿ç»­ï¼ˆä¾‹å¦‚ï¼šä¸»3-ä¸»4-ä¸»5ï¼‰
       if currRank != prevRank+1 {
           return fmt.Errorf("tractor values must be consecutive")
       }
   } else if currRank < 600 && prevRank < 600 {
       // å‰¯ç‰Œï¼šéœ€è¦è€ƒè™‘çº§ç‰Œè·³è¿‡
       prevBase := getCardNumericValue(uniqueCards[i-1].Value)
       currBase := getCardNumericValue(uniqueCards[i].Value)
       trumpRankBase := getCardNumericValue(trumpRank)

       // å¦‚æœçº§ç‰Œåœ¨ä¸¤å¼ ç‰Œä¹‹é—´ï¼Œå·®å€¼åº”è¯¥æ˜¯2ï¼›å¦åˆ™æ˜¯1
       if prevBase < trumpRankBase && currBase > trumpRankBase {
           if currBase != prevBase+2 {
               return fmt.Errorf("tractor values must be consecutive (considering trump rank skip)")
           }
       } else if currBase != prevBase+1 {
           return fmt.Errorf("tractor values must be consecutive")
       }
   }
   ```

---

### 3. æ›´æ–°å‡½æ•°è°ƒç”¨é“¾

ä¿®æ”¹æ‰€æœ‰è°ƒç”¨ `validateTractor()` çš„åœ°æ–¹ï¼Œä¼ é€’ `table` å‚æ•°ï¼š

1. **`validateLeadPlay()`**ï¼š
   ```go
   // æ—§ç­¾å
   func validateLeadPlay(cards []Card) error

   // æ–°ç­¾å
   func validateLeadPlay(cards []Card, table *GameTable) error

   // è°ƒç”¨æ—¶ä¼ é€’table
   if err := validateTractor(cards, table); err == nil {
       return nil // Valid tractor
   }
   ```

2. **`validateCardPlay()`**ï¼š
   ```go
   if isLead {
       // ä¼ é€’tableå‚æ•°
       return validateLeadPlay(cards, table)
   }
   ```

---

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ âŒ

| åœºæ™¯ | ç»“æœ | è¯´æ˜ |
|------|------|------|
| æ‰“5çº§ï¼šå‰¯ç‰Œ4å¯¹+6å¯¹ | âŒ è¢«æ‹’ç» | ä»£ç è®¤ä¸º4-6ä¸è¿ç»­ |
| æ‰“5çº§ï¼šä¸»4-ä¸»6ï¼ˆå¦‚æœä¸»èŠ±è‰²æ²¡æœ‰5ï¼‰ | âŒ è¢«æ‹’ç» | æ— æ³•è¯†åˆ«ä¸»ç‰Œçš„ç‰¹æ®Šé¡ºåº |
| çº§ç‰Œå‚ä¸æ‹–æ‹‰æœº | âŒ é”™è¯¯å¤„ç† | çº§ç‰Œåº”è¯¥ä½œä¸ºä¸»ç‰Œçš„ä¸€éƒ¨åˆ† |

### ä¿®å¤å âœ…

| åœºæ™¯ | ç»“æœ | è¯´æ˜ |
|------|------|------|
| æ‰“5çº§ï¼šå‰¯ç‰Œ4å¯¹+6å¯¹ | âœ… æœ‰æ•ˆæ‹–æ‹‰æœº | æ­£ç¡®è¯†åˆ«è·³è¿‡5 |
| æ‰“5çº§ï¼šä¸»4å¯¹+ä¸»6å¯¹ | âœ… æœ‰æ•ˆæ‹–æ‹‰æœº | ä¸»ç‰Œé¡ºåºï¼š...ä¸»6-ä¸»4-ä¸»3-ä¸»2ï¼ˆè·³è¿‡ä¸»5ï¼Œå› ä¸º5æ˜¯çº§ç‰Œï¼‰ |
| å‰¯5å¯¹+å‰¯6å¯¹ï¼ˆæ‰“5çº§ï¼‰ | âŒ æ— æ•ˆ | æ­£ç¡®æ‹’ç»ï¼š5æ˜¯çº§ç‰Œï¼Œä¸åœ¨å‰¯ç‰Œåºåˆ—ä¸­ |
| ä¸»3å¯¹+ä¸»4å¯¹+ä¸»6å¯¹ï¼ˆæ‰“5çº§ï¼‰ | âœ… æœ‰æ•ˆæ‹–æ‹‰æœº | æ­£ç¡®è¯†åˆ«ï¼šä¸»3-ä¸»4-ä¸»6è¿ç»­ï¼ˆè·³è¿‡ä¸»5ï¼‰ |

---

## æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šå‰¯ç‰Œè·³è¿‡çº§ç‰Œ

**æ¡ä»¶**ï¼š
- æ‰“5çº§ï¼ˆtrumpRank = "5"ï¼‰
- ä¸»ç‰ŒèŠ±è‰²ï¼šçº¢æ¡ƒï¼ˆtrumpSuit = "hearts"ï¼‰

**æµ‹è¯•æ¡ˆä¾‹**ï¼š
```
é»‘æ¡ƒ4å¯¹ + é»‘æ¡ƒ6å¯¹
âœ… åº”è¯¥æ˜¯æœ‰æ•ˆæ‹–æ‹‰æœºï¼ˆè·³è¿‡é»‘æ¡ƒ5ï¼Œå› ä¸º5æ˜¯çº§ç‰Œï¼‰

é»‘æ¡ƒ3å¯¹ + é»‘æ¡ƒ4å¯¹ + é»‘æ¡ƒ6å¯¹
âœ… åº”è¯¥æ˜¯æœ‰æ•ˆæ‹–æ‹‰æœºï¼ˆ3-4-6è¿ç»­ï¼Œè·³è¿‡5ï¼‰
```

### åœºæ™¯2ï¼šä¸»ç‰Œæ‹–æ‹‰æœº

**æ¡ä»¶**ï¼š
- æ‰“5çº§ï¼ˆtrumpRank = "5"ï¼‰
- ä¸»ç‰ŒèŠ±è‰²ï¼šçº¢æ¡ƒï¼ˆtrumpSuit = "hearts"ï¼‰

**æµ‹è¯•æ¡ˆä¾‹**ï¼š
```
çº¢æ¡ƒ4å¯¹ + çº¢æ¡ƒ6å¯¹
âœ… æœ‰æ•ˆä¸»ç‰Œæ‹–æ‹‰æœº
ç­‰çº§ï¼šä¸»4(604) -> ä¸»6(606)ï¼Œè¿ç»­ï¼ˆè·³è¿‡ä¸»5=çº§ç‰Œï¼‰

çº¢æ¡ƒ3å¯¹ + çº¢æ¡ƒ4å¯¹ + çº¢æ¡ƒ6å¯¹
âœ… æœ‰æ•ˆä¸»ç‰Œæ‹–æ‹‰æœº
ç­‰çº§ï¼šä¸»3(603) -> ä¸»4(604) -> ä¸»6(606)
```

### åœºæ™¯3ï¼šçº§ç‰Œæ‹–æ‹‰æœº

**æ¡ä»¶**ï¼š
- æ‰“5çº§ï¼ˆtrumpRank = "5"ï¼‰
- ä¸»ç‰ŒèŠ±è‰²ï¼šçº¢æ¡ƒï¼ˆtrumpSuit = "hearts"ï¼‰

**æµ‹è¯•æ¡ˆä¾‹**ï¼š
```
çº¢æ¡ƒ5å¯¹ + é»‘æ¡ƒ5å¯¹
âŒ æ— æ•ˆï¼ˆä¸è¿ç»­ï¼‰
çº¢æ¡ƒ5(800) å’Œ é»‘æ¡ƒ5(703) ç­‰çº§å·®è·å¤ªå¤§

é»‘æ¡ƒ5å¯¹ + æ–¹å—5å¯¹
âœ… å¯èƒ½æœ‰æ•ˆï¼ˆéœ€è¦æ£€æŸ¥å‰¯çº§ç‰Œä¹‹é—´æ˜¯å¦ç®—"è¿ç»­"ï¼‰
ç­‰çº§ï¼šé»‘æ¡ƒ5(703) -> æ–¹å—5(701)ï¼Œå·®å€¼ä¸º-2ï¼ˆé™åºï¼‰
```

---

## ä»£ç å˜æ›´ç»Ÿè®¡

| æŒ‡æ ‡ | æ•°é‡ |
|------|------|
| æ–°å¢å‡½æ•° | 1ä¸ªï¼ˆ`getCardRank`ï¼‰ |
| ä¿®æ”¹å‡½æ•° | 3ä¸ªï¼ˆ`validateTractor`, `validateLeadPlay`, `validateCardPlay`ï¼‰ |
| æ–°å¢ä»£ç è¡Œ | çº¦80è¡Œ |
| ä¿®æ”¹ä»£ç è¡Œ | çº¦40è¡Œ |

---

## ç¼–è¯‘æµ‹è¯•

```bash
cd D:/workshop/leve_up/backend && go build -o ../leve_up_test.exe
```

âœ… ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯

---

## åç»­å»ºè®®

### 1. å•å…ƒæµ‹è¯•

å»ºè®®ä¸º `getCardRank()` å’Œ `validateTractor()` ç¼–å†™å•å…ƒæµ‹è¯•ï¼š

```go
func TestGetCardRank(t *testing.T) {
    tests := []struct {
        card       Card
        trumpSuit  string
        trumpRank  string
        wantRank   int
        description string
    }{
        {Card{Type: "joker", Value: "big"}, "hearts", "5", 1000, "å¤§ç‹"},
        {Card{Suit: "hearts", Value: "5"}, "hearts", "5", 800, "ä¸»çº§ç‰Œ"},
        {Card{Suit: "spades", Value: "5"}, "hearts", "5", 703, "å‰¯çº§ç‰Œ-é»‘æ¡ƒ"},
        {Card{Suit: "hearts", Value: "A"}, "hearts", "5", 614, "ä¸»A"},
        {Card{Suit: "spades", Value: "A"}, "hearts", "5", 14, "å‰¯A"},
    }

    for _, tt := range tests {
        got := getCardRank(tt.card, tt.trumpSuit, tt.trumpRank)
        if got != tt.wantRank {
            t.Errorf("%s: got %d, want %d", tt.description, got, tt.wantRank)
        }
    }
}
```

### 2. é›†æˆæµ‹è¯•

åœ¨å®é™…æ¸¸æˆä¸­æµ‹è¯•ä»¥ä¸‹åœºæ™¯ï¼š
- å‰¯ç‰Œ4å¯¹+6å¯¹æ‹–æ‹‰æœºï¼ˆæ‰“5çº§ï¼‰
- ä¸»ç‰Œæ‹–æ‹‰æœºè·¨è¶Šçº§ç‰Œ
- çº§ç‰Œå‚ä¸çš„ç‰Œå‹ç»„åˆ

### 3. AIç­–ç•¥æ›´æ–°

éœ€è¦æ›´æ–°AIç©å®¶ç­–ç•¥ï¼Œä½¿å…¶èƒ½å¤Ÿï¼š
- è¯†åˆ«è·¨çº§ç‰Œçš„æ‹–æ‹‰æœº
- æ­£ç¡®è¯„ä¼°ä¸»ç‰Œæ‹–æ‹‰æœºçš„å¼ºåº¦
- åœ¨å‡ºç‰Œæ—¶è€ƒè™‘çº§ç‰Œè·³è¿‡çš„æƒ…å†µ

---

## æ€»ç»“

âœ… **BUG-002 å·²ä¿®å¤**

**å…³é”®æ”¹è¿›**ï¼š
1. âœ… å®ç°å®Œæ•´çš„ç‰Œç­‰çº§ç³»ç»Ÿï¼ˆ`getCardRank`ï¼‰
2. âœ… æ”¯æŒçº§ç‰Œè·³è¿‡è§„åˆ™ï¼ˆå¦‚4-6æ˜¯è¿ç»­çš„ï¼Œå½“5æ˜¯çº§ç‰Œæ—¶ï¼‰
3. âœ… æ­£ç¡®å¤„ç†ä¸»ç‰Œå’Œå‰¯ç‰Œçš„ä¸åŒç­‰çº§åºåˆ—
4. âœ… ç¼–è¯‘é€šè¿‡ï¼Œæ— è¯­æ³•é”™è¯¯

**å½±å“èŒƒå›´**ï¼š
- æ‹–æ‹‰æœºéªŒè¯é€»è¾‘
- ç‰Œå‹åˆ¤æ–­
- æ¸¸æˆè§„åˆ™æ­£ç¡®æ€§

**é£é™©è¯„ä¼°**ï¼š
- ğŸŸ¢ ä½é£é™©ï¼šä¿®æ”¹åŸºäºå·²æœ‰çš„éªŒè¯æ¡†æ¶ï¼Œåªæ˜¯æ”¹è¿›äº†åˆ¤æ–­é€»è¾‘
- ğŸŸ¢ å‘åå…¼å®¹ï¼šä¸å½±å“å…¶ä»–ç‰Œå‹ï¼ˆå•å¼ ã€å¯¹å­ã€ä¸‰å¼ ï¼‰çš„éªŒè¯

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2026-02-26
**ä¿®å¤äººå‘˜**ï¼šClaude Sonnet 4.5
**éªŒè¯çŠ¶æ€**ï¼šâœ… ä»£ç ä¿®å¤å®Œæˆï¼Œç¼–è¯‘é€šè¿‡
